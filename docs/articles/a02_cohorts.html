<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Working with cohorts • CDMConnector</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Working with cohorts">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CDMConnector</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01_getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/a02_cohorts.html">Working with cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a03_dbplyr.html">CDMConnector and dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/a04_DBI_connection_examples.html">DBI connection examples</a></li>
    <li><a class="dropdown-item" href="../articles/a06_using_cdm_attributes.html">Using CDM attributes</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/darwin-eu/CDMConnector/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Working with cohorts</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/darwin-eu/CDMConnector/blob/HEAD/vignettes/a02_cohorts.Rmd" class="external-link"><code>vignettes/a02_cohorts.Rmd</code></a></small>
      <div class="d-none name"><code>a02_cohorts.Rmd</code></div>
    </div>

    
    
<p>Cohorts are a fundamental building block for observational health
data analysis. A “cohort” is a set of persons satisfying a one or more
inclusion criteria for a duration of time. If you are familiar with the
idea of sets in math then a cohort can be nicely represented as a set of
person-days. In the OMOP Common Data Model we represent cohorts using a
table with four columns.</p>
<table class="table">
<caption>An example cohort table</caption>
<colgroup>
<col width="31%">
<col width="17%">
<col width="27%">
<col width="24%">
</colgroup>
<thead><tr class="header">
<th>cohort_definition_id</th>
<th>subject_id</th>
<th>cohort_start_date</th>
<th>cohort_end_date</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>1000</td>
<td>2020-01-01</td>
<td>2020-05-01</td>
</tr>
<tr class="even">
<td>1</td>
<td>1000</td>
<td>2021-06-01</td>
<td>2020-07-01</td>
</tr>
<tr class="odd">
<td>1</td>
<td>2000</td>
<td>2020-03-01</td>
<td>2020-09-01</td>
</tr>
<tr class="even">
<td>2</td>
<td>1000</td>
<td>2020-02-01</td>
<td>2020-03-01</td>
</tr>
</tbody>
</table>
<p>A cohort table can contain multiple cohorts and each cohort can have
multiple persons. There can even be multiple records for the same person
in a single cohort as long as the date ranges do not overlap. In the
same way that an element is either in a set or not, a single person-day
is either in a cohort or not. For a more comprehensive treatment of
cohorts in OHDSI check out the Cohorts chapter in <a href="https://ohdsi.github.io/TheBookOfOhdsi/Cohorts.html" class="external-link">The Book of
OHDSI</a>.</p>
<div class="section level2">
<h2 id="cohort-generation">Cohort Generation<a class="anchor" aria-label="anchor" href="#cohort-generation"></a>
</h2>
<p>The
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>*</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">n*4</annotation></semantics></math>
cohort table is created through the process of cohort
<em>generation</em>. To generate a cohort on a specific CDM dataset
means that we combine a <em>cohort definition</em> with CDM to produce a
cohort table. The standardization provided by the OMOP CDM allows
researchers to generate the same cohort definition on any OMOP CDM
dataset.</p>
<p>A cohort definition is an expression of the rules goverining the
inclusion/exclusion of person-days in the cohort. There are three common
ways to create cohort definitions for the OMOP CDM.</p>
<ol style="list-style-type: decimal">
<li><p>The Atlas cohort builder</p></li>
<li><p>The Capr R package</p></li>
<li><p>Custom SQL and/or R code</p></li>
</ol>
<p>Atlas is a web application that provides a graphical user interface
for creating cohort definitions. . To get started with Atlas check out
the free course on <a href="https://academy.ehden.eu/course/index.php" class="external-link">Ehden Academy</a> and
the demo at <a href="https://atlas-demo.ohdsi.org/" class="external-link uri">https://atlas-demo.ohdsi.org/</a>.</p>
<p>Capr is an R package that provides a code-based interface for
creating cohort definitions. The options available in Capr exactly match
the options available in Atlas and the resulting cohort tables should be
identical.</p>
<p>There are times when more customization is needed and it is possible
to use bespoke SQL or dplyr code to build a cohort. CDMConnector
provides the <code>generate_concept_cohort_set</code> function for
quickly building simple cohorts that can then be a starting point for
further subsetting.</p>
<p>Atlas cohorts are represented using json text files. To “generate”
one or more Atlas cohorts on a cdm object use the
<code>read_cohort_set</code> function to first read a folder of Atlas
cohort json files into R. Then create the cohort table with
<code>generate_cohort_set</code>. There can be an optional csv file
called “CohortsToCreate.csv” in the folder that specifies the cohort IDs
and names to use. If this file doesn’t exist IDs will be assigned
automatically using alphabetical order of the filenames.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pathToCohortJsonFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"cohorts1"</span>, package <span class="op">=</span> <span class="st">"CDMConnector"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">pathToCohortJsonFiles</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cerebral_venous_sinus_thrombosis_01.json"</span></span>
<span><span class="co">#&gt; [2] "CohortsToCreate.csv"                     </span></span>
<span><span class="co">#&gt; [3] "deep_vein_thrombosis_01.json"</span></span>
<span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">pathToCohortJsonFiles</span>, <span class="st">"CohortsToCreate.csv"</span><span class="op">)</span>,</span>
<span>                show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   cohortId cohortName                          jsonPath                         </span></span>
<span><span class="co">#&gt;      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                               <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>        1 cerebral_venous_sinus_thrombosis_01 cerebral_venous_sinus_thrombosis…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>        2 deep_vein_thrombosis_01             deep_vein_thrombosis_01.json</span></span></code></pre></div>
<div class="section level3">
<h3 id="atlas-cohort-definitions">Atlas cohort definitions<a class="anchor" aria-label="anchor" href="#atlas-cohort-definitions"></a>
</h3>
<p>First we need to create our CDM object. Note that we will need to
specify a <code>write_schema</code> when creating the object. Cohort
tables will go into the CDM’s <code>write_schema</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/CDMConnector/" class="external-link">CDMConnector</a></span><span class="op">)</span></span>
<span><span class="va">pathToCohortJsonFiles</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"example_cohorts"</span>, package <span class="op">=</span> <span class="st">"CDMConnector"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">pathToCohortJsonFiles</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "GiBleed_default.json" "GIBleed_male.json"</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="../reference/eunomiaDir.html">eunomiaDir</a></span><span class="op">(</span><span class="st">"GiBleed"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdmFromCon.html">cdmFromCon</a></span><span class="op">(</span><span class="va">con</span>, cdmName <span class="op">=</span> <span class="st">"eunomia"</span>, cdmSchema <span class="op">=</span> <span class="st">"main"</span>, writeSchema <span class="op">=</span> <span class="st">"main"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohortSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readCohortSet.html">readCohortSet</a></span><span class="op">(</span><span class="va">pathToCohortJsonFiles</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cohort_name <span class="op">=</span> <span class="fu">snakecase</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/snakecase/man/caseconverter.html" class="external-link">to_snake_case</a></span><span class="op">(</span><span class="va">cohort_name</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohortSet</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id cohort_name     cohort       json   cohort_name_snakecase</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;list&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1 gibleed_default <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;chr&gt;</span>  gibleed_default      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    2 gibleed_male    <span style="color: #949494;">&lt;named list&gt;</span> <span style="color: #949494;">&lt;chr&gt;</span>  gibleed_male</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet.html">generateCohortSet</a></span><span class="op">(</span></span>
<span>  cdm <span class="op">=</span> <span class="va">cdm</span>, </span>
<span>  cohortSet <span class="op">=</span> <span class="va">cohortSet</span>,</span>
<span>  name <span class="op">=</span> <span class="st">"study_cohorts"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating 2 cohorts</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating cohort (1/2) - gibleed_default</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generating cohort (1/2) - gibleed_default <span style="color: #B2B2B2;">[119ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating cohort (2/2) - gibleed_male</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generating cohort (2/2) - gibleed_male <span style="color: #B2B2B2;">[122ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">study_cohorts</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;study_cohorts&gt; [?? x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB v1.2.1 [root@Darwin 23.1.0:R 4.3.3//private/var/folders/2j/8z0yfn1j69q8sxjc7vj9yhz40000gp/T/Rtmp8T8uSI/file169e2add0028.duckdb]</span></span></span>
<span><span class="co">#&gt;    cohort_definition_id subject_id cohort_start_date cohort_end_date</span></span>
<span><span class="co">#&gt;                   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>                    1        304 1998-05-03        2019-06-17     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>                    1        807 1994-11-04        2019-03-19     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>                    1       <span style="text-decoration: underline;">1</span>674 2012-04-27        2019-06-10     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>                    1        987 1988-02-16        2019-06-02     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>                    1       <span style="text-decoration: underline;">1</span>201 2008-01-19        2018-10-31     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>                    1       <span style="text-decoration: underline;">5</span>278 2013-10-23        2019-06-14     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>                    1       <span style="text-decoration: underline;">1</span>352 1989-09-23        2019-02-03     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>                    1       <span style="text-decoration: underline;">3</span>195 1984-10-22        2019-01-07     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>                    1       <span style="text-decoration: underline;">3</span>438 1947-03-07        1992-01-11     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>                    1       <span style="text-decoration: underline;">3</span>822 1986-11-13        2019-05-20     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span></code></pre></div>
<p>The generated cohort has associated metadata tables. We can access
these with utility functions.</p>
<ul>
<li>
<code>cohort_count</code> contains the person and record counts for
each cohort in the cohort set</li>
<li>
<code>settings</code> table contains the cohort id and cohort
name</li>
<li>
<code>attrition</code> table contains the attrition information
(persons, and records dropped at each sequential inclusion rule)</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/cohortCount.html" class="external-link">cohortCount</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">study_cohorts</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id number_records number_subjects</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    2            237             237</span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/settings.html" class="external-link">settings</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">study_cohorts</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id cohort_name    </span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1 gibleed_default</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    2 gibleed_male</span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/attrition.html" class="external-link">attrition</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">study_cohorts</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id number_records number_subjects reason_id reason          </span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1            479             479         1 Qualifying init…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    1            479             479         2 Cohort records …</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                    2            479             479         1 Qualifying init…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                    2            237             237         2 Male            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                    2            237             237         3 30 days prior o…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>                    2            237             237         4 Cohort records …</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: excluded_records &lt;int&gt;, excluded_subjects &lt;int&gt;</span></span></span></code></pre></div>
<p>Note the this cohort table is still in the database so it can be
quite large. We can also join it to other CDM table or subset the entire
cdm to just the persons in the cohort.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm_gibleed</span> <span class="op">&lt;-</span> <span class="va">cdm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/cdmSubsetCohort.html">cdmSubsetCohort</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"study_cohorts"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="subset-a-cohort">Subset a cohort<a class="anchor" aria-label="anchor" href="#subset-a-cohort"></a>
</h3>
<p>Suppose you have a generated cohort and you would like to create a
new cohort that is a subset of the first. This can be done using the</p>
<p>First we will generate an example cohort set and then create a new
cohort based on filtering the Atlas cohort.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/CDMConnector/" class="external-link">CDMConnector</a></span><span class="op">)</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://r.duckdb.org/reference/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="../reference/eunomiaDir.html">eunomiaDir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdmFromCon.html">cdmFromCon</a></span><span class="op">(</span><span class="va">con</span>, cdmSchema <span class="op">=</span> <span class="st">"main"</span>, writeSchema <span class="op">=</span> <span class="st">"main"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohortSet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readCohortSet.html">readCohortSet</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"cohorts3"</span>, package <span class="op">=</span> <span class="st">"CDMConnector"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet.html">generateCohortSet</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohortSet</span>, name <span class="op">=</span> <span class="st">"cohort"</span><span class="op">)</span> </span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating 5 cohorts</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating cohort (1/5) - gibleed_all_end_10</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generating cohort (1/5) - gibleed_all_end_10 <span style="color: #B2B2B2;">[62ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating cohort (2/5) - gibleed_all</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generating cohort (2/5) - gibleed_all <span style="color: #B2B2B2;">[55ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating cohort (3/5) - gibleed_default_with_descendants</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generating cohort (3/5) - gibleed_default_with_descendants <span style="color: #B2B2B2;">[58ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating cohort (4/5) - gibleed_default</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generating cohort (4/5) - gibleed_default <span style="color: #B2B2B2;">[58ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Generating cohort (5/5) - gibleed_end_10</span></span>
<span><span class="co">#&gt; <span style="color: #00BB00;">✔</span> Generating cohort (5/5) - gibleed_end_10 <span style="color: #B2B2B2;">[58ms]</span></span></span>
<span><span class="co">#&gt; </span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;cohort&gt; [?? x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB v1.2.1 [root@Darwin 23.1.0:R 4.3.3//private/var/folders/2j/8z0yfn1j69q8sxjc7vj9yhz40000gp/T/Rtmp8T8uSI/file169e2121b1c36.duckdb]</span></span></span>
<span><span class="co">#&gt;    cohort_definition_id subject_id cohort_start_date cohort_end_date</span></span>
<span><span class="co">#&gt;                   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>                    1        163 2010-04-25        2010-05-05     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>                    1       <span style="text-decoration: underline;">1</span>088 2011-09-10        2011-09-20     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>                    1       <span style="text-decoration: underline;">4</span>544 1984-06-02        1984-06-12     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>                    1        693 1995-09-01        1995-09-11     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>                    1       <span style="text-decoration: underline;">1</span>525 1998-12-22        1999-01-01     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>                    1       <span style="text-decoration: underline;">2</span>103 2010-11-02        2010-11-12     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>                    1       <span style="text-decoration: underline;">2</span>485 1953-04-30        1953-05-10     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>                    1       <span style="text-decoration: underline;">3</span>216 1995-12-22        1996-01-01     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>                    1       <span style="text-decoration: underline;">4</span>340 2010-04-28        2010-05-08     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>                    1       <span style="text-decoration: underline;">5</span>142 1985-05-16        1985-05-26     </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ more rows</span></span></span>
<span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/cohortCount.html" class="external-link">cohortCount</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 3</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id number_records number_subjects</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    2            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                    3            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                    4            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                    5            479             479</span></span></code></pre></div>
<p>As an example we will take only people in the cohort that have a
cohort duration that is longer than 4 weeks. Using dplyr we can write
this query and save the result in a new table in the cdm.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort_subset</span> <span class="op">&lt;-</span> <span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co"># only keep persons who are in the cohort at least 28 days</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/datediff.html">datediff</a></span><span class="op">(</span><span class="st">"cohort_start_date"</span>, <span class="st">"cohort_end_date"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">28</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"cohort_subset"</span>, temporary <span class="op">=</span> <span class="cn">FALSE</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/newCohortTable.html" class="external-link">newCohortTable</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/cohortCount.html" class="external-link">cohortCount</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort_subset</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 3</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id number_records number_subjects</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    2            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                    3            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                    4            479             479</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                    5            479             479</span></span></code></pre></div>
<p>In this case we can see that cohorts 1 and 5 were dropped completely
and some patients were dropped from cohorts 2, 3, and 4.</p>
<p>Let’s confirm that everyone in cohorts 1 and 5 were in the cohort for
less than 28 days.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">daysInCohort</span> <span class="op">&lt;-</span> <span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cohort_definition_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>days_in_cohort <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/datediff.html">datediff</a></span><span class="op">(</span><span class="st">"cohort_start_date"</span>, <span class="st">"cohort_end_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">cohort_definition_id</span>, <span class="va">days_in_cohort</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">daysInCohort</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 8 × 3</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id days_in_cohort     n</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1              2     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    1              1    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                    5              1    10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                    1             10   467</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                    5              9     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>                    5              2     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>                    1              9     1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>                    5             10   467</span></span></code></pre></div>
<p>We have confirmed that everyone in cohorts 1 and 5 were in the cohort
less than 10 days.</p>
<p>Now suppose we would like to create a new cohort table with three
different versions of the cohorts in the original cohort table. We will
keep persons who are in the cohort at 2 weeks, 3 weeks, and 4 weeks. We
can simply write some custom dplyr to create the table and then call
<code>new_generated_cohort_set</code> just like in the previous
example.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort_subset</span> <span class="op">&lt;-</span> <span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/datediff.html">datediff</a></span><span class="op">(</span><span class="st">"cohort_start_date"</span>, <span class="st">"cohort_end_date"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">14</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cohort_definition_id <span class="op">=</span> <span class="fl">10</span> <span class="op">+</span> <span class="va">cohort_definition_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/setops.html" class="external-link">union_all</a></span><span class="op">(</span></span>
<span>    <span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/datediff.html">datediff</a></span><span class="op">(</span><span class="st">"cohort_start_date"</span>, <span class="st">"cohort_end_date"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">21</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cohort_definition_id <span class="op">=</span> <span class="fl">100</span> <span class="op">+</span> <span class="va">cohort_definition_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/setops.html" class="external-link">union_all</a></span><span class="op">(</span></span>
<span>    <span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/datediff.html">datediff</a></span><span class="op">(</span><span class="st">"cohort_start_date"</span>, <span class="st">"cohort_end_date"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">28</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cohort_definition_id <span class="op">=</span> <span class="fl">1000</span> <span class="op">+</span> <span class="va">cohort_definition_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">compute</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"cohort_subset"</span>, temporary <span class="op">=</span> <span class="cn">FALSE</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co"># %&gt;% </span></span>
<span>  <span class="co"># newCohortTable() # this function creates the cohort object and metadata</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort_subset</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>days_in_cohort <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/datediff.html">datediff</a></span><span class="op">(</span><span class="st">"cohort_start_date"</span>, <span class="st">"cohort_end_date"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cohort_definition_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mean_days_in_cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">days_in_cohort</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">mean_days_in_cohort</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 9 × 2</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id mean_days_in_cohort</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                   14               <span style="text-decoration: underline;">7</span>586.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                   13               <span style="text-decoration: underline;">7</span>586.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>                   12               <span style="text-decoration: underline;">7</span>586.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>                  103               <span style="text-decoration: underline;">7</span>602.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>                 <span style="text-decoration: underline;">1</span>004               <span style="text-decoration: underline;">7</span>602.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>                  102               <span style="text-decoration: underline;">7</span>602.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span>                 <span style="text-decoration: underline;">1</span>002               <span style="text-decoration: underline;">7</span>602.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">8</span>                 <span style="text-decoration: underline;">1</span>003               <span style="text-decoration: underline;">7</span>602.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">9</span>                  104               <span style="text-decoration: underline;">7</span>602.</span></span></code></pre></div>
<p>This is an example of creating new cohorts from existing cohorts
using CDMConnector. There is a lot of flexibility with this approach.
Next we will look at completely custom cohort creation which is quite
similar.</p>
</div>
<div class="section level3">
<h3 id="custom-cohort-creation">Custom Cohort Creation<a class="anchor" aria-label="anchor" href="#custom-cohort-creation"></a>
</h3>
<p>Sometimes you may want to create cohorts that cannot be easily
expressed using Atlas or Capr. In these situations you can create
implement cohort creation using SQL or R. See the chapter in <a href="https://ohdsi.github.io/TheBookOfOhdsi/Cohorts.html#implementing-the-cohort-using-sql" class="external-link">The
Book of OHDSI</a> for details on using SQL to create cohorts.
CDMConnector provides a helper function to build simple cohorts from a
list of OMOP concepts. <code>generate_concept_cohort_set</code> accepts
a named list of concept sets and will create cohorts based on those
concept sets. While this function does not allow for inclusion/exclusion
criteria in the initial definition, additional criteria can be applied
“manually” after the initial generation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateConceptCohortSet.html">generateConceptCohortSet</a></span><span class="op">(</span></span>
<span>  <span class="va">cdm</span>, </span>
<span>  conceptSet <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gibleed <span class="op">=</span> <span class="fl">192671</span><span class="op">)</span>, </span>
<span>  name <span class="op">=</span> <span class="st">"gibleed2"</span>, <span class="co"># name of the cohort table</span></span>
<span>  limit <span class="op">=</span> <span class="st">"all"</span>, <span class="co"># use all occurrences of the concept instead of just the first</span></span>
<span>  end <span class="op">=</span> <span class="fl">10</span> <span class="co"># set explicit cohort end date 10 days after start</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">gibleed2</span> <span class="op">&lt;-</span> <span class="va">cdm</span><span class="op">$</span><span class="va">gibleed2</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html" class="external-link">semi_join</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">person</span>, <span class="va">gender_concept_id</span> <span class="op">==</span> <span class="fl">8507</span><span class="op">)</span>, </span>
<span>    by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"subject_id"</span> <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/recordCohortAttrition.html" class="external-link">recordCohortAttrition</a></span><span class="op">(</span>reason <span class="op">=</span> <span class="st">"Male"</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/attrition.html" class="external-link">attrition</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">gibleed2</span><span class="op">)</span> </span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 7</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id number_records number_subjects reason_id reason          </span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1            479             479         1 Initial qualify…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>                    1            237             237         2 Male            </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: excluded_records &lt;int&gt;, excluded_subjects &lt;int&gt;</span></span></span></code></pre></div>
<p>In the above example we built a cohort table from a concept set. The
cohort essentially captures patient-time based off of the presence or
absence of OMOP standard concept IDs. We then manually applied an
inclusion criteria and recorded a new attrition record in the cohort. To
learn more about this approach to building cohorts check out the <a href="https://darwin-eu.github.io/PatientProfiles/" class="external-link">PatientProfiles</a>
R package.</p>
<p>You can also create a generated cohort set using any method you
choose. As long as the table is in the CDM database and has the four
required columns it can be added to the CDM object as a generated cohort
set.</p>
<p>Suppose for example our cohort table is</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cohort</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  cohort_definition_id <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  subject_id <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>  cohort_start_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"1999-01-01"</span><span class="op">)</span>,</span>
<span>  cohort_end_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2001-01-01"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohort</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id subject_id cohort_start_date cohort_end_date</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1          1 1999-01-01        2001-01-01</span></span></code></pre></div>
<p>First make sure the table is in the database and create a dplyr table
reference to it and add it to the CDM object.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/omopgenerics/" class="external-link">omopgenerics</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'omopgenerics'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/insertTable.html" class="external-link">insertTable</a></span><span class="op">(</span>cdm <span class="op">=</span> <span class="va">cdm</span>, name <span class="op">=</span> <span class="st">"cohort"</span>, table <span class="op">=</span> <span class="va">cohort</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;cohort&gt; [?? x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB v1.2.1 [root@Darwin 23.1.0:R 4.3.3//private/var/folders/2j/8z0yfn1j69q8sxjc7vj9yhz40000gp/T/Rtmp8T8uSI/file169e2121b1c36.duckdb]</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id subject_id cohort_start_date cohort_end_date</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1          1 1999-01-01        2001-01-01</span></span></code></pre></div>
<p>To make this a true generated cohort object use the
<code>cohort_table</code></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/newCohortTable.html" class="external-link">newCohortTable</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span><span class="op">)</span></span></code></pre></div>
<p>We can see that this cohort is now has the class “cohort_table” as
well as the various metadata tables.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/cohortCount.html" class="external-link">cohortCount</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id number_records number_subjects</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1              1               1</span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/settings.html" class="external-link">settings</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id cohort_name</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1 cohort_1</span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/attrition.html" class="external-link">attrition</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id number_records number_subjects reason_id reason          </span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>           <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>           </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1              1               1         1 Initial qualify…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: excluded_records &lt;int&gt;, excluded_subjects &lt;int&gt;</span></span></span></code></pre></div>
<p>If you would like to override the attribute tables then pass
additional dataframes to cohortTable</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/insertTable.html" class="external-link">insertTable</a></span><span class="op">(</span>cdm <span class="op">=</span> <span class="va">cdm</span>, name <span class="op">=</span> <span class="st">"cohort2"</span>, table <span class="op">=</span> <span class="va">cohort</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/newCohortTable.html" class="external-link">newCohortTable</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/settings.html" class="external-link">settings</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id cohort_name</span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1 cohort_1</span></span>
<span></span>
<span><span class="va">cohort_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cohort_definition_id <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>                         cohort_name <span class="op">=</span> <span class="st">"made_up_cohort"</span><span class="op">)</span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/newCohortTable.html" class="external-link">newCohortTable</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort2</span>, cohortSetRef <span class="op">=</span> <span class="va">cohort_set</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://darwin-eu.github.io/omopgenerics/reference/settings.html" class="external-link">settings</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort2</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   cohort_definition_id cohort_name   </span></span>
<span><span class="co">#&gt;                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>                    1 made_up_cohort</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Cohort building is a fundamental building block of observational
health analysis and CDMConnector supports different ways of creating
cohorts. As long as your cohort table is has the required structure and
columns you can add it to the cdm with the
<code>new_generated_cohort_set</code> function and use it in any
downstream OHDSI analytic packages.</p>
<div style="margin-bottom:3cm;">

</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adam Black, Artem Gorbachev, Edward Burn, Marti Catala Sabate, Ioanna Nika.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
