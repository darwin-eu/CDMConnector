<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Incremental DAG Caching for Cohort Generation • CDMConnector</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Incremental DAG Caching for Cohort Generation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CDMConnector</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01_getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/a02_cohorts.html">Working with cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a03_dbplyr.html">CDMConnector and dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/a04_DBI_connection_examples.html">DBI connection examples</a></li>
    <li><a class="dropdown-item" href="../articles/a06_using_cdm_attributes.html">Using CDM attributes</a></li>
    <li><a class="dropdown-item" href="../articles/a07_batch-optimization.html">DAG-Based Batch Optimization for Cohort SQL Generation</a></li>
    <li><a class="dropdown-item" href="../articles/a08_dag-caching.html">Incremental DAG Caching for Cohort Generation</a></li>
    <li><a class="dropdown-item" href="../articles/a09_benchmarking.html">Multi-Database Benchmarking: Old vs New Cohort Generation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/darwin-eu/CDMConnector/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Incremental DAG Caching for Cohort Generation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/darwin-eu/CDMConnector/blob/HEAD/vignettes/a08_dag-caching.Rmd" class="external-link"><code>vignettes/a08_dag-caching.Rmd</code></a></small>
      <div class="d-none name"><code>a08_dag-caching.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>When iterating on cohort definitions, you often change one part of a
definition and re-run. Without caching, the entire pipeline re-executes
from scratch: concept set expansion, primary events, qualified events,
inclusion rules, and final cohort construction – even for the parts that
haven’t changed.</p>
<p><code>atlasCohortGenerator</code> implements <strong>incremental DAG
caching</strong>: a system that persists intermediate computation tables
in the database and skips recomputation of unchanged nodes. This is the
same principle behind build systems like Make and Bazel –
content-addressable caching with automatic invalidation via Merkle-tree
hashing.</p>
<p>This vignette explains:</p>
<ol style="list-style-type: decimal">
<li>How caching works (Merkle-tree hashing, the registry, and
cache-aware execution)</li>
<li>How to enable caching in your workflow</li>
<li>What gets cached vs. what’s always recomputed</li>
<li>Cache management (inspection, garbage collection, clearing)</li>
<li>Correctness guarantees</li>
</ol>
</div>
<div class="section level2">
<h2 id="how-it-works">How It Works<a class="anchor" aria-label="anchor" href="#how-it-works"></a>
</h2>
<div class="section level3">
<h3 id="the-execution-dag">The Execution DAG<a class="anchor" aria-label="anchor" href="#the-execution-dag"></a>
</h3>
<p>Each cohort definition is decomposed into a directed acyclic graph
(DAG) of typed computation nodes:</p>
<pre><code>concept_set (CS)
       |
primary_events (PE)
       |
qualified_events (QE)
       |
inclusion_rule (IR) [0..N]
       |
included_events (IE)
       |
cohort_exit (CE)
       |
final_cohort (FC)</code></pre>
<p>Each node is identified by a <strong>content hash</strong> – a
deterministic 16-character hex string derived from the node’s
definition. Two nodes with the same definition produce the same hash,
regardless of which cohort they came from.</p>
</div>
<div class="section level3">
<h3 id="merkle-tree-hashing">Merkle-Tree Hashing<a class="anchor" aria-label="anchor" href="#merkle-tree-hashing"></a>
</h3>
<p>The critical property that makes caching safe is <strong>Merkle-tree
hashing</strong>: each node’s hash incorporates the hashes of its
dependencies, not just its own definition.</p>
<p>For example, a <code>qualified_events</code> node’s hash is computed
from:</p>
<ul>
<li>Its own parameters (qualified limit type, sort order)</li>
<li>The hash of its parent <code>primary_events</code> node</li>
<li>The hash of any additional criteria group</li>
</ul>
<p>This means if you change a concept set, the change propagates up
through the entire DAG:</p>
<pre><code>CS (concept_id=123) --&gt; hash: a1b2c3d4...
  PE (uses CS hash) --&gt; hash: e5f6a7b8...
    QE (uses PE hash) --&gt; hash: 1234abcd...
      ...

CS (concept_id=999) --&gt; hash: ff00ee11...   &lt;-- changed
  PE (uses CS hash) --&gt; hash: 2233aabb...   &lt;-- also changed (different dep hash)
    QE (uses PE hash) --&gt; hash: ccdd4455... &lt;-- also changed
      ...</code></pre>
<p><strong>No explicit invalidation logic is needed.</strong> A change
anywhere automatically produces different hashes for all downstream
nodes.</p>
</div>
<div class="section level3">
<h3 id="the-cache-registry">The Cache Registry<a class="anchor" aria-label="anchor" href="#the-cache-registry"></a>
</h3>
<p>The cache registry is a database table
(<code>dag_cache_registry</code>) that maps node hashes to materialized
table names:</p>
<table class="table">
<thead><tr class="header">
<th>Column</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>node_hash</code></td>
<td>16-char hex content hash (primary key)</td>
</tr>
<tr class="even">
<td><code>node_type</code></td>
<td>Node type (<code>primary_events</code>,
<code>qualified_events</code>, etc.)</td>
</tr>
<tr class="odd">
<td><code>table_name</code></td>
<td>Fully qualified table name of the materialized result</td>
</tr>
<tr class="even">
<td><code>created_at</code></td>
<td>When the node was first materialized</td>
</tr>
<tr class="odd">
<td><code>last_used_at</code></td>
<td>Last time the node was accessed (for GC)</td>
</tr>
<tr class="even">
<td><code>cohort_ids</code></td>
<td>Comma-separated list of cohort IDs using this node</td>
</tr>
</tbody>
</table>
<p>The registry is created automatically the first time you use
<code>cache = TRUE</code>.</p>
</div>
<div class="section level3">
<h3 id="stable-table-naming">Stable Table Naming<a class="anchor" aria-label="anchor" href="#stable-table-naming"></a>
</h3>
<p>When caching is enabled, all node tables use a <strong>fixed
prefix</strong> (<code>dagcache_</code>) instead of the random
<code>atlas_&lt;uuid&gt;_</code> prefix used for ephemeral runs. This
means the same computation always maps to the same table name:</p>
<ul>
<li>
<code>dagcache_pe_a1b2c3d4</code> – primary events node with hash
starting <code>a1b2c3d4</code>
</li>
<li>
<code>dagcache_qe_e5f6a7b8</code> – qualified events node with hash
starting <code>e5f6a7b8</code>
</li>
</ul>
<p>This determinism is what allows cache lookups to work across separate
sessions.</p>
</div>
<div class="section level3">
<h3 id="cache-aware-execution">Cache-Aware Execution<a class="anchor" aria-label="anchor" href="#cache-aware-execution"></a>
</h3>
<p>When you run with <code>cache = TRUE</code>, the execution proceeds
as follows:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Build the DAG</strong> from cohort definitions (same as
non-cached mode)</li>
<li>
<strong>Compute content hashes</strong> for all nodes (Merkle-tree,
bottom-up)</li>
<li>
<strong>Query the registry</strong> for each node hash</li>
<li>
<strong>Validate</strong> that cached tables still physically exist
in the database</li>
<li>
<strong>Skip</strong> nodes that are valid cache hits</li>
<li>
<strong>Execute SQL</strong> for cache misses only</li>
<li>
<strong>Register</strong> newly computed nodes in the registry</li>
<li>
<strong>Clean up</strong> ephemeral tables (staging,
domain-filtered), but <strong>preserve</strong> cached node tables</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<div class="section level3">
<h3 id="basic-usage">Basic Usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First run: all nodes computed from scratch</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohortSet</span>, name <span class="op">=</span> <span class="st">"my_cohorts"</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; DAG cache: 0 hits, 12 misses (12 nodes to compute)</span></span>
<span></span>
<span><span class="co"># Modify one cohort's inclusion rule and re-run:</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohortSet_v2</span>, name <span class="op">=</span> <span class="st">"my_cohorts"</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; DAG cache: 8 hits, 4 misses (4 nodes to compute)</span></span></code></pre></div>
<p>On the second run, only the nodes affected by the change are
recomputed. Shared upstream nodes (concept sets, primary events) that
haven’t changed are reused from the cache.</p>
</div>
<div class="section level3">
<h3 id="sql-only-usage">SQL-Only Usage<a class="anchor" aria-label="anchor" href="#sql-only-usage"></a>
</h3>
<p>You can also use caching at the SQL generation level:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/atlas_json_to_sql_batch.html" class="external-link">atlas_json_to_sql_batch</a></span><span class="op">(</span></span>
<span>  json_inputs <span class="op">=</span> <span class="va">cohortSet</span>,</span>
<span>  cdm_schema <span class="op">=</span> <span class="st">"cdm"</span>,</span>
<span>  results_schema <span class="op">=</span> <span class="st">"results"</span>,</span>
<span>  target_dialect <span class="op">=</span> <span class="st">"duckdb"</span>,</span>
<span>  cache <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  con <span class="op">=</span> <span class="va">con</span>,</span>
<span>  resolved_schema <span class="op">=</span> <span class="st">"results"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># result$sql         -- SQL string (only computes cache misses)</span></span>
<span><span class="co"># result$cache_hits  -- character vector of skipped node hashes</span></span>
<span><span class="co"># result$cache_misses -- character vector of nodes to compute</span></span>
<span><span class="co"># result$dag         -- the full DAG object</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="what-gets-cached-vs--not">What Gets Cached vs. Not<a class="anchor" aria-label="anchor" href="#what-gets-cached-vs--not"></a>
</h2>
<div class="section level3">
<h3 id="cached-persistent-across-runs">Cached (persistent across runs)<a class="anchor" aria-label="anchor" href="#cached-persistent-across-runs"></a>
</h3>
<p>These are the intermediate computation tables that are expensive to
compute and whose results depend only on their content hash:</p>
<table class="table">
<colgroup>
<col width="28%">
<col width="38%">
<col width="33%">
</colgroup>
<thead><tr class="header">
<th>Node Type</th>
<th>Table Pattern</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>primary_events</code></td>
<td><code>dagcache_pe_&lt;hash&gt;</code></td>
<td>Events matching primary criteria</td>
</tr>
<tr class="even">
<td><code>qualified_events</code></td>
<td><code>dagcache_qe_&lt;hash&gt;</code></td>
<td>Events after additional criteria + limit</td>
</tr>
<tr class="odd">
<td><code>inclusion_rule</code></td>
<td><code>dagcache_ir_&lt;hash&gt;</code></td>
<td>Per-rule matching person/event pairs</td>
</tr>
<tr class="even">
<td><code>included_events</code></td>
<td><code>dagcache_ie_&lt;hash&gt;</code></td>
<td>Events surviving all inclusion rules</td>
</tr>
<tr class="odd">
<td><code>cohort_exit</code></td>
<td><code>dagcache_ce_&lt;hash&gt;</code></td>
<td>Cohort end dates</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="not-cached-rebuilt-every-run">Not Cached (rebuilt every run)<a class="anchor" aria-label="anchor" href="#not-cached-rebuilt-every-run"></a>
</h3>
<p>These are either cheap to rebuild, specific to a single run, or
inherently transient:</p>
<table class="table">
<colgroup>
<col width="30%">
<col width="69%">
</colgroup>
<thead><tr class="header">
<th>Table</th>
<th>Why Not Cached</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>dagcache_codesets</code></td>
<td>Fast to rebuild; shared across all nodes</td>
</tr>
<tr class="even">
<td><code>dagcache_all_concepts</code></td>
<td>Derived from codesets</td>
</tr>
<tr class="odd">
<td>Domain filtered tables</td>
<td>Depend on the full set of concepts in the current batch</td>
</tr>
<tr class="even">
<td>Staging tables</td>
<td>Transient accumulation tables</td>
</tr>
<tr class="odd">
<td><code>dagcache_fc_&lt;hash&gt;</code></td>
<td>Final cohort inserts into staging; table itself is dropped</td>
</tr>
<tr class="even">
<td>Auxiliary tables (<code>_ie</code>, <code>_se</code>,
<code>_cr</code>)</td>
<td>Intermediate join tables within a node</td>
</tr>
</tbody>
</table>
</div>
<div class="section level3">
<h3 id="why-concept-sets-arent-individually-cached">Why Concept Sets Aren’t Individually Cached<a class="anchor" aria-label="anchor" href="#why-concept-sets-arent-individually-cached"></a>
</h3>
<p>Concept sets are handled via a single global
<code>dagcache_codesets</code> table that contains all unique concept
set expressions assigned global IDs. This table is rebuilt each run
because:</p>
<ol style="list-style-type: decimal">
<li>It’s cheap (just vocabulary lookups)</li>
<li>It must contain exactly the concept sets needed by the current
batch</li>
<li>Its structure (single table with all sets) doesn’t fit the
one-table-per-node caching model</li>
</ol>
<p>However, concept set <em>hashes</em> are still used in the Merkle
tree – they affect downstream node hashes, ensuring correctness.</p>
</div>
</div>
<div class="section level2">
<h2 id="cache-management">Cache Management<a class="anchor" aria-label="anchor" href="#cache-management"></a>
</h2>
<div class="section level3">
<h3 id="inspecting-the-cache">Inspecting the Cache<a class="anchor" aria-label="anchor" href="#inspecting-the-cache"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># List all cached entries</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_list.html" class="external-link">dag_cache_list</a></span><span class="op">(</span><span class="va">con</span>, schema <span class="op">=</span> <span class="st">"results"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get summary statistics</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_stats.html" class="external-link">dag_cache_stats</a></span><span class="op">(</span><span class="va">con</span>, schema <span class="op">=</span> <span class="st">"results"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $total_entries</span></span>
<span><span class="co">#&gt; [1] 15</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; $by_type</span></span>
<span><span class="co">#&gt; primary_events qualified_events  inclusion_rule  included_events</span></span>
<span><span class="co">#&gt;              4                4               3                2</span></span>
<span><span class="co">#&gt;    cohort_exit</span></span>
<span><span class="co">#&gt;              2</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="garbage-collection">Garbage Collection<a class="anchor" aria-label="anchor" href="#garbage-collection"></a>
</h3>
<p>Over time, as cohort definitions evolve, old cached tables become
orphaned – they’re no longer referenced by any current cohort
definition. The garbage collector removes these:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Remove entries not used in the last 30 days</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_gc.html" class="external-link">dag_cache_gc</a></span><span class="op">(</span><span class="va">con</span>, schema <span class="op">=</span> <span class="st">"results"</span>, max_age_days <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Preview what would be removed (dry run)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_gc.html" class="external-link">dag_cache_gc</a></span><span class="op">(</span><span class="va">con</span>, schema <span class="op">=</span> <span class="st">"results"</span>, max_age_days <span class="op">=</span> <span class="fl">7</span>, dry_run <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Remove everything</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_gc.html" class="external-link">dag_cache_gc</a></span><span class="op">(</span><span class="va">con</span>, schema <span class="op">=</span> <span class="st">"results"</span>, max_age_days <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>The GC also detects <strong>orphaned entries</strong> – registry rows
whose backing table has been dropped externally – and cleans those up
regardless of age.</p>
</div>
<div class="section level3">
<h3 id="clearing-the-cache">Clearing the Cache<a class="anchor" aria-label="anchor" href="#clearing-the-cache"></a>
</h3>
<p>To remove all cached tables and start fresh:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_clear.html" class="external-link">dag_cache_clear</a></span><span class="op">(</span><span class="va">con</span>, schema <span class="op">=</span> <span class="st">"results"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Cleared 15 cache entries.</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="correctness-guarantees">Correctness Guarantees<a class="anchor" aria-label="anchor" href="#correctness-guarantees"></a>
</h2>
<p>The caching system provides these guarantees:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Content-addressed</strong>: Two computations with
identical inputs always produce the same hash. There are no false cache
hits from stale data.</p></li>
<li>
<p><strong>Merkle-tree propagation</strong>: Changing any upstream
definition (concept set, criteria, observation window, etc.) produces a
different hash for every downstream node. This is tested directly:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Changing concept_id from 123 to 999 changes ALL downstream hashes</span></span>
<span><span class="va">dag_a</span> <span class="op">&lt;-</span> <span class="fu">build_execution_dag</span><span class="op">(</span><span class="va">cohort_a</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="va">dag_b</span> <span class="op">&lt;-</span> <span class="fu">build_execution_dag</span><span class="op">(</span><span class="va">cohort_b</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="co"># PE, QE, IE, CE, FC hashes all differ between dag_a and dag_b</span></span></code></pre></div>
</li>
<li><p><strong>Physical validation</strong>: Before declaring a cache
hit, the system verifies that the backing table still exists in the
database. If someone drops a cached table externally, it will be
recomputed on the next run.</p></li>
<li><p><strong>Immutability</strong>: Cached tables are never modified
after creation. The hash is a promise that the table contents match the
definition.</p></li>
<li><p><strong>No cross-contamination</strong>: The
<code>final_cohort</code> node includes <code>cohort_id</code> in its
hash, so two cohorts with identical logic but different IDs produce
separate final cohort nodes (which are not cached anyway – they insert
into staging and are dropped).</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="when-to-use-caching">When to Use Caching<a class="anchor" aria-label="anchor" href="#when-to-use-caching"></a>
</h2>
<p>Caching is most beneficial when:</p>
<ul>
<li>
<strong>Iterating on cohort definitions</strong>: changing one
inclusion rule in a set of 20 cohorts → only the affected nodes
recompute</li>
<li>
<strong>Adding/removing cohorts from a batch</strong>: unchanged
cohorts reuse all their cached intermediates</li>
<li>
<strong>Re-running after a failed partial execution</strong>:
successfully computed nodes persist even after errors</li>
<li>
<strong>Working with large CDM databases</strong>: primary events
and qualified events scans are expensive; caching avoids repeating
them</li>
</ul>
<p>Caching adds minimal overhead (registry lookups are fast) and can be
disabled at any time by omitting <code>cache = TRUE</code>.</p>
</div>
<div class="section level2">
<h2 id="example-incremental-update">Example: Incremental Update<a class="anchor" aria-label="anchor" href="#example-incremental-update"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Day 1: Generate 3 cohorts</span></span>
<span><span class="va">cohortSet_v1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  cohort_definition_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">json_diabetes</span>, <span class="va">json_hypertension</span>, <span class="va">json_ckd</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohortSet_v1</span>, <span class="st">"cohorts"</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; DAG cache: 0 hits, 18 misses (18 nodes to compute)</span></span>
<span></span>
<span><span class="co"># Day 2: Replace the CKD definition, keep diabetes and hypertension</span></span>
<span><span class="va">cohortSet_v2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  cohort_definition_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">json_diabetes</span>, <span class="va">json_hypertension</span>, <span class="va">json_ckd_v2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohortSet_v2</span>, <span class="st">"cohorts"</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; DAG cache: 12 hits, 6 misses (6 nodes to compute)</span></span>
<span><span class="co"># Diabetes and hypertension nodes reused; only CKD nodes recomputed</span></span>
<span></span>
<span><span class="co"># Day 3: Add a 4th cohort</span></span>
<span><span class="va">cohortSet_v3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  cohort_definition_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">json_diabetes</span>, <span class="va">json_hypertension</span>, <span class="va">json_ckd_v2</span>, <span class="va">json_stroke</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohortSet_v3</span>, <span class="st">"cohorts"</span>, cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; DAG cache: 18 hits, 6 misses (6 nodes to compute)</span></span>
<span><span class="co"># All 3 existing cohorts reused; only stroke computed</span></span>
<span></span>
<span><span class="co"># Inspect what's cached</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_stats.html" class="external-link">dag_cache_stats</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"results"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $total_entries</span></span>
<span><span class="co">#&gt; [1] 24</span></span>
<span></span>
<span><span class="co"># Clean up old entries</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/dag_cache_gc.html" class="external-link">dag_cache_gc</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"results"</span>, max_age_days <span class="op">=</span> <span class="fl">90</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adam Black, Artem Gorbachev, Edward Burn, Marti Catala Sabate, Ioanna Nika.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
