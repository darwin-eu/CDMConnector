<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting Started • CDMConnector</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting Started">
<meta property="og:description" content="CDMConnector">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CDMConnector</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/DBI_connection_examples.html">DBI connection examples</a>
    </li>
    <li>
      <a href="../articles/SQL.html">Using SQL from R</a>
    </li>
    <li>
      <a href="../articles/cdm_reference_backends.html">CDM reference backends</a>
    </li>
    <li>
      <a href="../articles/dbplyr.html">CDMConnector and dbplyr</a>
    </li>
    <li>
      <a href="../articles/getting-started.html">Getting Started</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting Started</h1>
            
      
      
      <div class="hidden name"><code>getting-started.Rmd</code></div>

    </div>

    
    
<p>The CDMConnector package provides tools for working OMOP Common Data
Model (CDM) tables in a pipe friendly syntax. CDM table references are
stored in a single compound object along with CDM specific metadata.</p>
<p>The main function provided by the package is
<code>cdm_from_con</code> which creates a CDM connection object that can
be used with dplyr verbs. In the examples that we will use a <a href="https://duckdb.org/" class="external-link">duckdb</a> database which is embedded in the
CDMConnector package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">CDMConnector</span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/duckdb/man/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, dbdir <span class="op">=</span> <span class="fu"><a href="../reference/eunomia_dir.html">eunomia_dir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_schema <span class="op">=</span> <span class="st">"main"</span><span class="op">)</span></span>
<span><span class="va">cdm</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: person, observation_period, visit_occurrence, visit_detail, condition_occurrence, drug_exposure, procedure_occurrence, measurement, observation, death, location, care_site, provider, drug_era, dose_era, condition_era, cdm_source, concept, vocabulary, concept_relationship, concept_synonym, concept_ancestor, drug_strength</span></span></code></pre></div>
<p>Individual CDM table references can be accessed using <code>$</code>
and piped to dplyr verbs.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span>, warn.conflicts <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">person</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   SQL [1 x 1]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 0.5.1 [root@Darwin 21.6.0:R 4.2.0//var/folders/xx/01v98b6546ldnm1rg1_bvk000000gn/T//RtmpjHIyox/qpslzwjb/cdm.duckdb]</span></span></span>
<span><span class="co">#&gt;       n</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>  <span style="text-decoration: underline;">2</span>694</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">drug_exposure</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">concept</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"drug_concept_id"</span> <span class="op">=</span> <span class="st">"concept_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span>drug <span class="op">=</span> <span class="va">concept_name</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:     SQL [?? x 2]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database:   DuckDB 0.5.1 [root@Darwin 21.6.0:R 4.2.0//var/folders/xx/01v98b6546ldnm1rg1_bvk000000gn/T//RtmpjHIyox/qpslzwjb/cdm.duckdb]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Ordered by: desc(n)</span></span></span>
<span><span class="co">#&gt;    drug                                                                        n</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                                                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Acetaminophen 325 MG Oral Tablet                                         <span style="text-decoration: underline;">9</span>365</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> poliovirus vaccine, inactivated                                          <span style="text-decoration: underline;">7</span>977</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> tetanus and diphtheria toxoids, adsorbed, preservative free, for adult…  <span style="text-decoration: underline;">7</span>430</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Aspirin 81 MG Oral Tablet                                                <span style="text-decoration: underline;">4</span>380</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Amoxicillin 250 MG / Clavulanate 125 MG Oral Tablet                      <span style="text-decoration: underline;">3</span>851</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> hepatitis A vaccine, adult dosage                                        <span style="text-decoration: underline;">3</span>211</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Acetaminophen 160 MG Oral Tablet                                         <span style="text-decoration: underline;">2</span>158</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> zoster vaccine, live                                                     <span style="text-decoration: underline;">2</span>125</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Acetaminophen 21.7 MG/ML / Dextromethorphan Hydrobromide 1 MG/ML / dox…  <span style="text-decoration: underline;">1</span>993</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> hepatitis B vaccine, adult dosage                                        <span style="text-decoration: underline;">1</span>916</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with more rows</span></span></span></code></pre></div>
<p>To send SQL to the CDM use the connection object. The cdm reference
also contains the connection as an attribute that can be accessed with
the <code>dbcon</code> function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select count(*) as person_count from main.person"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   person_count</span></span>
<span><span class="co">#&gt; 1         2694</span></span>
<span></span>
<span><span class="co"># get the connection from a cdm object using the function `remote_con` from dbplyr</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="fu">dbplyr</span><span class="fu">::</span><span class="fu"><a href="https://dbplyr.tidyverse.org/reference/remote_name.html" class="external-link">remote_con</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">person</span><span class="op">)</span>, <span class="st">"select count(*) as person_count from main.person"</span><span class="op">)</span></span>
<span><span class="co">#&gt;   person_count</span></span>
<span><span class="co">#&gt; 1         2694</span></span></code></pre></div>
<p>To create SQL that can be executed across multiple database platforms
the SqlRender package can be used.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu">SqlRender</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/translate.html" class="external-link">translate</a></span><span class="op">(</span><span class="st">"select count(*) as person_count from main.person"</span>,</span>
<span>                            targetDialect <span class="op">=</span> <span class="fu"><a href="../reference/dbms.html">dbms</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="va">sql</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="select-a-subset-of-cdm-tables">Select a subset of CDM tables<a class="anchor" aria-label="anchor" href="#select-a-subset-of-cdm-tables"></a>
</h2>
<p>If you do not need references to all tables you can easily select
only a subset of tables to include in the cdm reference. The
<code>select</code> argument of <code>cdm_from_con</code> supports the
<a href="https://tidyselect.r-lib.org/reference/language.html" class="external-link">tidyselect
selection language</a> and provides a new selection helper:
<code>tbl_group</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"concept"</span><span class="op">)</span><span class="op">)</span> <span class="co"># tables that start with 'concept'</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: concept, concept_class, concept_relationship, concept_synonym, concept_ancestor</span></span>
<span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">contains</a></span><span class="op">(</span><span class="st">"era"</span><span class="op">)</span><span class="op">)</span> <span class="co"># tables that contain the substring 'era'</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: drug_era, dose_era, condition_era</span></span>
<span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="fu"><a href="../reference/tbl_group.html">tbl_group</a></span><span class="op">(</span><span class="st">"vocab"</span><span class="op">)</span><span class="op">)</span> <span class="co"># pre-defined groups</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: concept, vocabulary, domain, concept_class, concept_relationship, relationship, concept_synonym, concept_ancestor, source_to_concept_map, drug_strength</span></span>
<span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person"</span>, <span class="st">"observation_period"</span><span class="op">)</span><span class="op">)</span> <span class="co"># character vector</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: person, observation_period</span></span>
<span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">person</span>, <span class="va">observation_period</span><span class="op">)</span><span class="op">)</span> <span class="co"># bare names</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: person, observation_period</span></span>
<span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">matches</a></span><span class="op">(</span><span class="st">"person|period"</span><span class="op">)</span><span class="op">)</span> <span class="co"># regular expression</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: person, observation_period, payer_plan_period</span></span>
<span></span>
<span><span class="co"># If you are using a variable to hold selections then use the `all_of` selection helper</span></span>
<span><span class="va">tables_to_include</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person"</span>, <span class="st">"observation_period"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">tables_to_include</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># OMOP CDM reference (tbl_duckdb_connection)</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Tables: person, observation_period</span></span></code></pre></div>
<p><code>tbl_group</code> supports several subsets of the CDM: “all”,
“clinical”, “vocab”, “derived”, and “default”.</p>
<p>The default set of CDM tables included in a CDM object is:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/tbl_group.html">tbl_group</a></span><span class="op">(</span><span class="st">"default"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "person"               "observation_period"   "visit_occurrence"    </span></span>
<span><span class="co">#&gt;  [4] "visit_detail"         "condition_occurrence" "drug_exposure"       </span></span>
<span><span class="co">#&gt;  [7] "procedure_occurrence" "measurement"          "observation"         </span></span>
<span><span class="co">#&gt; [10] "death"                "location"             "care_site"           </span></span>
<span><span class="co">#&gt; [13] "provider"             "drug_era"             "dose_era"            </span></span>
<span><span class="co">#&gt; [16] "condition_era"        "cdm_source"           "concept"             </span></span>
<span><span class="co">#&gt; [19] "vocabulary"           "concept_relationship" "concept_synonym"     </span></span>
<span><span class="co">#&gt; [22] "concept_ancestor"     "drug_strength"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="include-cohort-tables">Include cohort tables<a class="anchor" aria-label="anchor" href="#include-cohort-tables"></a>
</h2>
<p>It is common to use one or more cohort tables along with the CDM. A
cohort table has the following structure and can be created by
CDMConnector or SQL or another package.</p>
<p>Creation of cohort tables is outside of the scope of the CDMConnector
package. Cohort tables need to be a separate schema from the CDM tables
where the user has both read and write access. Once the cohort table is
created in the database it can be added to the cdm object as
follows.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/listTables.html">listTables</a></span><span class="op">(</span><span class="va">con</span>, schema <span class="op">=</span> <span class="st">"write_schema"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cohort"</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, </span>
<span>                    cdm_tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person"</span>, <span class="st">"observation_period"</span><span class="op">)</span>, </span>
<span>                    write_schema <span class="op">=</span> <span class="st">"write_schema"</span>,</span>
<span>                    cohort_tables <span class="op">=</span> <span class="st">"cohort"</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Source:   table&lt;write_schema.cohort&gt; [2 x 4]</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Database: DuckDB 0.5.1 [root@Darwin 21.6.0:R 4.2.0//var/folders/xx/01v98b6546ldnm1rg1_bvk000000gn/T//RtmpjHIyox/qpslzwjb/cdm.duckdb]</span></span></span>
<span><span class="co">#&gt;   cohort_id subject_id cohort_start_date cohort_end_date</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>         1          1 2022-11-18        2022-11-18     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>         1          2 2020-02-03        2020-11-04</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="extracting-data">Extracting data<a class="anchor" aria-label="anchor" href="#extracting-data"></a>
</h2>
<p>There are two ways to extract subsets of the CDM.</p>
<ul>
<li><p><code>collect</code> pulls data into R</p></li>
<li><p><code>stow</code> saves the cdm subset to a set of files on disk
in either parquet, feather, or csv format</p></li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">local_cdm</span> <span class="op">&lt;-</span> <span class="va">cdm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The cdm tables are now dataframes</span></span>
<span><span class="va">local_cdm</span><span class="op">$</span><span class="va">person</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span> </span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 4</span></span></span>
<span><span class="co">#&gt;   person_id gender_concept_id year_of_birth month_of_birth</span></span>
<span><span class="co">#&gt;       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>         6              <span style="text-decoration: underline;">8</span>532          <span style="text-decoration: underline;">1</span>963             12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>       123              <span style="text-decoration: underline;">8</span>507          <span style="text-decoration: underline;">1</span>950              4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>       129              <span style="text-decoration: underline;">8</span>507          <span style="text-decoration: underline;">1</span>974             10</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>        16              <span style="text-decoration: underline;">8</span>532          <span style="text-decoration: underline;">1</span>971             10</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">save_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"tmp"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">save_path</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="../reference/stow.html">stow</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">save_path</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">save_path</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cohort.parquet"             "observation_period.parquet"</span></span>
<span><span class="co">#&gt; [3] "person.parquet"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-a-cdm-reference-from-files">Create a CDM reference from files<a class="anchor" aria-label="anchor" href="#create-a-cdm-reference-from-files"></a>
</h2>
<p><code>stow</code> saves the cdm object as a set of files.
<code>cdm_from_files</code> read the files back into R as a
cdm_reference object. The tables can be stored as R dataframes or Arrow
Tables. In both cases cdm tables can be manipulated with
<code>dplyr</code> verbs.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdm_from_files.html">cdm_from_files</a></span><span class="op">(</span><span class="va">save_path</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "tbl_df"     "tbl"        "data.frame"</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cdm_from_files.html">cdm_from_files</a></span><span class="op">(</span><span class="va">save_path</span>, </span>
<span>                      cdm_tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cohort"</span>, <span class="st">"observation_period"</span>, <span class="st">"person"</span><span class="op">)</span>, </span>
<span>                      as_data_frame <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The `cdm_tables` argument of `cdm_from_files()` is deprecated as of CDMConnector 0.2.0.</span></span>
<span><span class="co">#&gt; Ability to select a subset of cdm tables when reading a cdm from files has been deprecated. All cdm table files are read into R.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Table"        "ArrowTabular" "ArrowObject"  "R6"</span></span>
<span></span>
<span><span class="va">cdm</span><span class="op">$</span><span class="va">cohort</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">tally</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="closing-connections">Closing connections<a class="anchor" aria-label="anchor" href="#closing-connections"></a>
</h2>
<p>Close the database connection with <code>dbDisconnect</code>. After
the connection is closed the cdm object can no longer be used.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="delaying-connections">Delaying connections<a class="anchor" aria-label="anchor" href="#delaying-connections"></a>
</h2>
<p>Sometimes you may need to delay the creation of a cdm connection or
create and close many connections during execution. CDMConnector
provides the ability to store connection information that can be passed
to <code>dbConnect</code> to create a connection. The typical use case
is to create a new connection inside a function and then close the
connection before the function exits.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connection_details</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dbConnectDetails.html">dbConnectDetails</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/duckdb/man/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, dbdir <span class="op">=</span> <span class="fu"><a href="../reference/eunomia_dir.html">eunomia_dir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">self_contained_query</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">connection_details</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># create a new connection</span></span>
<span>  <span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="va">connection_details</span><span class="op">)</span></span>
<span>  <span class="co"># close the connection before exiting </span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># use the connection</span></span>
<span>  <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbGetQuery.html" class="external-link">dbGetQuery</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"select count(*) as n from main.person"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">self_contained_query</span><span class="op">(</span><span class="va">connection_details</span><span class="op">)</span></span>
<span><span class="co">#&gt;      n</span></span>
<span><span class="co">#&gt; 1 2694</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="programming-with-cdm-objects">Programming with cdm objects<a class="anchor" aria-label="anchor" href="#programming-with-cdm-objects"></a>
</h2>
<p>Since cdm object can include any subset of cdm tables it is important
for functions that take cdm objects as input to check that the expected
tables exists. The <code>assert_tables</code> function provides a
checkmate style function that tests if the expected tables exist, have
the correct columns, and (optionally) are not empty. It can also be used
with checkmate assert collections.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mllg.github.io/checkmate/" class="external-link">checkmate</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbConnect.html" class="external-link">dbConnect</a></span><span class="op">(</span><span class="fu">duckdb</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/duckdb/man/duckdb.html" class="external-link">duckdb</a></span><span class="op">(</span><span class="op">)</span>, dbdir <span class="op">=</span> <span class="fu"><a href="../reference/eunomia_dir.html">eunomia_dir</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/assert_tables.html">assertTables</a></span><span class="op">(</span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="st">"drug_era"</span><span class="op">)</span>, tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `assertTables()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> - person table not found in cdm object</span></span>
<span></span>
<span><span class="co"># add missing table error to collection</span></span>
<span><span class="va">err</span> <span class="op">&lt;-</span> <span class="fu">checkmate</span><span class="fu">::</span><span class="fu"><a href="https://mllg.github.io/checkmate/reference/AssertCollection.html" class="external-link">makeAssertCollection</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/assert_tables.html">assertTables</a></span><span class="op">(</span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="st">"drug_era"</span><span class="op">)</span>, tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person"</span><span class="op">)</span>, add <span class="op">=</span> <span class="va">err</span><span class="op">)</span></span>
<span><span class="va">err</span><span class="op">$</span><span class="fu">getMessages</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "- person table not found in cdm object"</span></span></code></pre></div>
<p><code>assert_tables</code> can be used in functions that accept
<code>cdm_reference</code> objects as a parameter.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">countDrugsByGender</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cdm</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/assert_tables.html">assertTables</a></span><span class="op">(</span><span class="va">cdm</span>, tables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"person"</span>, <span class="st">"drug_era"</span><span class="op">)</span>, empty.ok <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cdm</span><span class="op">$</span><span class="va">person</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">cdm</span><span class="op">$</span><span class="va">drug_era</span>, by <span class="op">=</span> <span class="st">"person_id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">gender_concept_id</span>, <span class="va">.data</span><span class="op">$</span><span class="va">drug_concept_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html" class="external-link">collect</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">countDrugsByGender</span><span class="op">(</span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span>, cdm_tables <span class="op">=</span> <span class="st">"person"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `assertTables()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> - drug_era table not found in cdm object</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbExecute.html" class="external-link">dbExecute</a></span><span class="op">(</span><span class="va">con</span>, <span class="st">"delete from drug_era"</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 52508</span></span>
<span><span class="fu">countDrugsByGender</span><span class="op">(</span><span class="fu"><a href="../reference/cdm_from_con.html">cdm_from_con</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `assertTables()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> - drug_era cdm table is empty</span></span>
<span></span>
<span><span class="fu">DBI</span><span class="fu">::</span><span class="fu"><a href="https://dbi.r-dbi.org/reference/dbDisconnect.html" class="external-link">dbDisconnect</a></span><span class="op">(</span><span class="va">con</span>, shutdown <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="code-style">Code style<a class="anchor" aria-label="anchor" href="#code-style"></a>
</h2>
<p>Camel case aliases are provided for many functions to fit both
<code>snake_case</code> and <code>camelCase</code> programming
styles.</p>
</div>
<div class="section level2">
<h2 id="supported-dbi-drivers">Supported DBI drivers<a class="anchor" aria-label="anchor" href="#supported-dbi-drivers"></a>
</h2>
<p>The <code>cdm_from_con</code> function should work with any DBI
driver backend implementation. However the package is tested using the
following driver backends.</p>
<ul>
<li><p><a href="https://rpostgres.r-dbi.org/" class="external-link">RPostgres</a> for Postgres
and Redshift</p></li>
<li><p><a href="https://github.com/r-dbi/odbc" class="external-link">odbc</a> for Microsoft
SQL Server</p></li>
<li>
<p><a href="https://duckdb.org/docs/api/r" class="external-link">duckdb</a></p>
<div style="margin-bottom:3cm;">

</div>
</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Adam Black.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
