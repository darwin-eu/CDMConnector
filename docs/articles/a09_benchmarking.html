<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Multi-Database Benchmarking: Old vs New Cohort Generation • CDMConnector</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multi-Database Benchmarking: Old vs New Cohort Generation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CDMConnector</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01_getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/a02_cohorts.html">Working with cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a03_dbplyr.html">CDMConnector and dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/a04_DBI_connection_examples.html">DBI connection examples</a></li>
    <li><a class="dropdown-item" href="../articles/a06_using_cdm_attributes.html">Using CDM attributes</a></li>
    <li><a class="dropdown-item" href="../articles/a07_batch-optimization.html">DAG-Based Batch Optimization for Cohort SQL Generation</a></li>
    <li><a class="dropdown-item" href="../articles/a08_dag-caching.html">Incremental DAG Caching for Cohort Generation</a></li>
    <li><a class="dropdown-item" href="../articles/a09_benchmarking.html">Multi-Database Benchmarking: Old vs New Cohort Generation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/darwin-eu/CDMConnector/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Multi-Database Benchmarking: Old vs New Cohort Generation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/darwin-eu/CDMConnector/blob/HEAD/vignettes/a09_benchmarking.Rmd" class="external-link"><code>vignettes/a09_benchmarking.Rmd</code></a></small>
      <div class="d-none name"><code>a09_benchmarking.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette describes how to benchmark
<strong>CDMConnector::generateCohortSet</strong> (old, CIRCE-based)
against <strong>atlasCohortGenerator::generateCohortSet2</strong> (new,
DAG-optimized batch) across multiple database platforms. The
benchmarking script:</p>
<ol style="list-style-type: decimal">
<li>Runs both methods on each database with the same cohort set.</li>
<li>Records <strong>overall time</strong> for each method and writes
results to a CSV.</li>
<li>
<strong>Confirms that the two cohort tables have identical
rows</strong> (order ignored) and writes per-database and per-cohort
equivalence results to a second CSV.</li>
</ol>
<p>Supported platforms include <strong>PostgreSQL</strong>,
<strong>Redshift</strong>, <strong>Snowflake</strong>,
<strong>Spark</strong>, and <strong>SQL Server</strong>. You provide a
named list of CDM reference objects; the script handles timing,
comparison, and CSV output.</p>
</div>
<div class="section level2">
<h2 id="performance-improvements-with-the-new-approach">Performance improvements with the new approach<a class="anchor" aria-label="anchor" href="#performance-improvements-with-the-new-approach"></a>
</h2>
<p>The new approach (<code>generateCohortSet2</code>) uses a
<strong>DAG-based batch optimizer</strong> that:</p>
<ul>
<li>
<strong>Shares vocabulary expansion</strong>: Concept set expansion
and codeset building are done once and reused across all cohorts,
instead of once per cohort.</li>
<li>
<strong>Shares domain scans</strong>: Filtered domain tables
(e.g. drug exposure, condition occurrence) are built once and read by
every cohort that needs them.</li>
<li>
<strong>Reduces I/O</strong>: A single batch script writes to shared
staging tables and finalizes in one pass, instead of N separate
DELETE/INSERT cycles.</li>
</ul>
<p>As a result, <strong>wall-clock time typically decreases</strong> as
the number of cohorts and the overlap in concept sets increase. The
ratio (new time / old time) is often <strong>below 1.0</strong>, with
larger batches showing greater speedups. The exact improvement depends
on:</p>
<ul>
<li>Number of cohorts and size of each definition</li>
<li>Overlap in concept sets and domains across cohorts</li>
<li>Database engine and hardware</li>
</ul>
<p>The benchmarking script records <code>time_old_sec</code>,
<code>time_new_sec</code>, and <code>ratio_new_over_old</code> per
database so you can measure the speedup on your own data and
platforms.</p>
</div>
<div class="section level2">
<h2 id="how-to-run-the-benchmark">How to run the benchmark<a class="anchor" aria-label="anchor" href="#how-to-run-the-benchmark"></a>
</h2>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<ul>
<li>
<strong>CDMConnector</strong> and
<strong>atlasCohortGenerator</strong> installed (or
<code><a href="https://devtools.r-lib.org/reference/load_all.html" class="external-link">devtools::load_all()</a></code> for the latter).</li>
<li>One or more <strong>live CDM connections</strong> (e.g. Postgres,
Redshift, Snowflake, Spark, SQL Server) as CDM reference objects.</li>
<li>A <strong>cohort set</strong> (e.g. from
<code>CDMConnector::readCohortSet("path/to/cohorts")</code>).</li>
</ul>
</div>
<div class="section level3">
<h3 id="single-database">Single database<a class="anchor" aria-label="anchor" href="#single-database"></a>
</h3>
<p>For one CDM, use the single-database benchmark and optional
equivalence check:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"extras/benchmark_cohort_generation.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohort_set</span> <span class="op">&lt;-</span> <span class="fu">CDMConnector</span><span class="fu">::</span><span class="fu"><a href="../reference/readCohortSet.html">readCohortSet</a></span><span class="op">(</span><span class="st">"path/to/cohorts"</span><span class="op">)</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">benchmark_cohort_generation</span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohort_set</span>, cohort_path <span class="op">=</span> <span class="st">"path/to/cohorts"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare old vs new cohort tables (identical rows, order ignored)</span></span>
<span><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu">compare_cohort_tables</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">cdm</span>, name_old <span class="op">=</span> <span class="st">"cohort_bench_old"</span>, name_new <span class="op">=</span> <span class="st">"cohort_bench_new"</span><span class="op">)</span></span>
<span><span class="va">cmp</span><span class="op">$</span><span class="va">identical</span>   <span class="co"># TRUE if same set of rows</span></span>
<span><span class="va">cmp</span><span class="op">$</span><span class="va">per_cohort</span>  <span class="co"># Per-cohort row counts and match status</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="multiple-databases">Multiple databases<a class="anchor" aria-label="anchor" href="#multiple-databases"></a>
</h3>
<p>Pass a <strong>named list of CDM objects</strong>; names are used as
the <code>database</code> identifier in the output CSVs
(e.g. <code>postgres</code>, <code>redshift</code>,
<code>snowflake</code>, <code>spark</code>,
<code>sql_server</code>):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"extras/benchmark_cohort_generation.R"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"extras/benchmark_multi_database.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cohort_set</span> <span class="op">&lt;-</span> <span class="fu">CDMConnector</span><span class="fu">::</span><span class="fu"><a href="../reference/readCohortSet.html">readCohortSet</a></span><span class="op">(</span><span class="st">"path/to/cohorts"</span><span class="op">)</span></span>
<span><span class="va">cdms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  postgres   <span class="op">=</span> <span class="va">cdm_postgres</span>,</span>
<span>  redshift   <span class="op">=</span> <span class="va">cdm_redshift</span>,</span>
<span>  snowflake  <span class="op">=</span> <span class="va">cdm_snowflake</span>,</span>
<span>  spark      <span class="op">=</span> <span class="va">cdm_spark</span>,</span>
<span>  sql_server <span class="op">=</span> <span class="va">cdm_sqlserver</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">run_benchmark_multi_database</span><span class="op">(</span></span>
<span>  cdms <span class="op">=</span> <span class="va">cdms</span>,</span>
<span>  cohort_set <span class="op">=</span> <span class="va">cohort_set</span>,</span>
<span>  cohort_path <span class="op">=</span> <span class="st">"path/to/cohorts"</span>,</span>
<span>  results_csv <span class="op">=</span> <span class="st">"benchmark_results.csv"</span>,</span>
<span>  equivalence_csv <span class="op">=</span> <span class="st">"benchmark_equivalence.csv"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ul>
<li>
<strong>benchmark_results.csv</strong>: one row per database with
<code>database</code>, <code>time_old_sec</code>,
<code>time_new_sec</code>, <code>ratio_new_over_old</code>,
<code>n_cohorts</code>, <code>files_included</code>,
<code>status</code>.</li>
<li>
<strong>benchmark_equivalence.csv</strong>: one row per database
(overall) plus one row per (database, cohort_definition_id) with
<code>n_old</code>, <code>n_new</code>, <code>rows_identical</code>,
<code>status</code>.</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="benchmark-results-csv-timing">Benchmark results CSV (timing)<a class="anchor" aria-label="anchor" href="#benchmark-results-csv-timing"></a>
</h2>
<p>The timing CSV has one row per database. Example structure:</p>
<table style="width:100%;" class="table">
<colgroup>
<col width="8%">
<col width="9%">
<col width="9%">
<col width="14%">
<col width="7%">
<col width="44%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">database</th>
<th align="right">time_old_sec</th>
<th align="right">time_new_sec</th>
<th align="right">ratio_new_over_old</th>
<th align="right">n_cohorts</th>
<th align="left">files_included</th>
<th align="left">status</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">postgres</td>
<td align="right">120.5</td>
<td align="right">45.2</td>
<td align="right">0.38</td>
<td align="right">4</td>
<td align="left">cohort_a.json; cohort_b.json; cohort_c.json;
cohort_d.json</td>
<td align="left">ok</td>
</tr>
<tr class="even">
<td align="left">redshift</td>
<td align="right">95.2</td>
<td align="right">38.0</td>
<td align="right">0.40</td>
<td align="right">4</td>
<td align="left">cohort_a.json; cohort_b.json; cohort_c.json;
cohort_d.json</td>
<td align="left">ok</td>
</tr>
<tr class="odd">
<td align="left">snowflake</td>
<td align="right">88.1</td>
<td align="right">32.5</td>
<td align="right">0.37</td>
<td align="right">4</td>
<td align="left">cohort_a.json; cohort_b.json; cohort_c.json;
cohort_d.json</td>
<td align="left">ok</td>
</tr>
<tr class="even">
<td align="left">sql_server</td>
<td align="right">110.3</td>
<td align="right">42.1</td>
<td align="right">0.38</td>
<td align="right">4</td>
<td align="left">cohort_a.json; cohort_b.json; cohort_c.json;
cohort_d.json</td>
<td align="left">ok</td>
</tr>
</tbody>
</table>
<ul>
<li>
<strong>ratio_new_over_old</strong> &lt; 1 means the new method was
faster.</li>
<li>
<strong>files_included</strong> lists the cohort definition files
(or names) in the cohort set.</li>
</ul>
</div>
<div class="section level2">
<h2 id="equivalence-csv-same-results">Equivalence CSV (same results)<a class="anchor" aria-label="anchor" href="#equivalence-csv-same-results"></a>
</h2>
<p>The equivalence CSV confirms that the <strong>old and new cohort
tables contain the same rows</strong> (order ignored). Each database
has:</p>
<ol style="list-style-type: decimal">
<li>An <strong>overall</strong> row (with
<code>cohort_definition_id</code> NA): total row counts and whether the
full tables match.</li>
<li>
<strong>Per-cohort</strong> rows: row counts from the old table
(<code>n_old</code>), from the new table (<code>n_new</code>), and
whether the set of rows for that cohort is identical
(<code>rows_identical</code>).</li>
</ol>
<p>Example:</p>
<table class="table">
<thead><tr class="header">
<th align="left">database</th>
<th align="right">cohort_definition_id</th>
<th align="right">n_old</th>
<th align="right">n_new</th>
<th align="left">rows_identical</th>
<th align="left">status</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">postgres</td>
<td align="right">NA</td>
<td align="right">15000</td>
<td align="right">15000</td>
<td align="left">TRUE</td>
<td align="left">ok</td>
</tr>
<tr class="even">
<td align="left">postgres</td>
<td align="right">1</td>
<td align="right">5000</td>
<td align="right">5000</td>
<td align="left">TRUE</td>
<td align="left">ok</td>
</tr>
<tr class="odd">
<td align="left">postgres</td>
<td align="right">2</td>
<td align="right">6000</td>
<td align="right">6000</td>
<td align="left">TRUE</td>
<td align="left">ok</td>
</tr>
<tr class="even">
<td align="left">postgres</td>
<td align="right">3</td>
<td align="right">4000</td>
<td align="right">4000</td>
<td align="left">TRUE</td>
<td align="left">ok</td>
</tr>
<tr class="odd">
<td align="left">redshift</td>
<td align="right">NA</td>
<td align="right">15000</td>
<td align="right">15000</td>
<td align="left">TRUE</td>
<td align="left">ok</td>
</tr>
<tr class="even">
<td align="left">redshift</td>
<td align="right">1</td>
<td align="right">5000</td>
<td align="right">5000</td>
<td align="left">TRUE</td>
<td align="left">ok</td>
</tr>
</tbody>
</table>
<p>When <strong>rows_identical</strong> is TRUE for all cohorts (and the
overall row), the new approach produces <strong>exactly the same cohort
membership and dates</strong> as the old CIRCE-based method; only
execution strategy and performance differ.</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<table class="table">
<colgroup>
<col width="38%">
<col width="61%">
</colgroup>
<thead><tr class="header">
<th>Aspect</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>Performance</strong></td>
<td>The new batch optimizer typically reduces wall-clock time (ratio
&lt; 1) by sharing vocabulary and domain work across cohorts.</td>
</tr>
<tr class="even">
<td><strong>Correctness</strong></td>
<td>The benchmarking pipeline compares old and new cohort tables
row-by-row (order ignored) and writes equivalence results to CSV.</td>
</tr>
<tr class="odd">
<td><strong>Platforms</strong></td>
<td>Run the same cohort set on Postgres, Redshift, Snowflake, Spark, and
SQL Server by passing a named list of CDMs to
<code>run_benchmark_multi_database()</code>.</td>
</tr>
</tbody>
</table>
<p>Use the generated CSVs to document speedups and to confirm identical
results across databases and between the two cohort generation
methods.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adam Black, Artem Gorbachev, Edward Burn, Marti Catala Sabate, Ioanna Nika.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
