<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>DAG-Based Batch Optimization for Cohort SQL Generation • CDMConnector</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="DAG-Based Batch Optimization for Cohort SQL Generation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CDMConnector</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.5.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/a01_getting-started.html">Getting Started</a></li>
    <li><a class="dropdown-item" href="../articles/a02_cohorts.html">Working with cohorts</a></li>
    <li><a class="dropdown-item" href="../articles/a03_dbplyr.html">CDMConnector and dbplyr</a></li>
    <li><a class="dropdown-item" href="../articles/a04_DBI_connection_examples.html">DBI connection examples</a></li>
    <li><a class="dropdown-item" href="../articles/a06_using_cdm_attributes.html">Using CDM attributes</a></li>
    <li><a class="dropdown-item" href="../articles/a07_batch-optimization.html">DAG-Based Batch Optimization for Cohort SQL Generation</a></li>
    <li><a class="dropdown-item" href="../articles/a08_dag-caching.html">Incremental DAG Caching for Cohort Generation</a></li>
    <li><a class="dropdown-item" href="../articles/a09_benchmarking.html">Multi-Database Benchmarking: Old vs New Cohort Generation</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/darwin-eu/CDMConnector/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>DAG-Based Batch Optimization for Cohort SQL Generation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/darwin-eu/CDMConnector/blob/HEAD/vignettes/a07_batch-optimization.Rmd" class="external-link"><code>vignettes/a07_batch-optimization.Rmd</code></a></small>
      <div class="d-none name"><code>a07_batch-optimization.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>When generating SQL for multiple ATLAS cohort definitions, the naive
approach treats each cohort independently – parsing its JSON, expanding
its concept sets against the vocabulary, scanning CDM domain tables,
building qualified events, and writing results. This works, but it
repeats expensive database operations (vocabulary joins, full-table
scans, result-table I/O) once per cohort.</p>
<p><code>atlasCohortGenerator</code> implements a <strong>DAG-based
batch optimizer</strong> that reorganizes a set of cohort SQL scripts
into a single execution plan with shared intermediate stages. The
optimizer produces <strong>semantically identical results</strong> to
the one-at-a-time approach while eliminating redundant work.</p>
<p>This vignette explains:</p>
<ol style="list-style-type: decimal">
<li>How the one-at-a-time (CIRCE-based) approach works</li>
<li>How the optimized batch DAG is structured</li>
<li>How we guarantee equivalence between the two approaches</li>
<li>Performance characteristics under different workload types</li>
</ol>
</div>
<div class="section level2">
<h2 id="the-one-at-a-time-approach">The One-at-a-Time Approach<a class="anchor" aria-label="anchor" href="#the-one-at-a-time-approach"></a>
</h2>
<p>The traditional CIRCE approach generates a fully self-contained SQL
script for each cohort. Every script independently performs five
phases:</p>
<div style="text-align:center;">
<p><img src="fig/cohort-json-141031.png" style="width:35%;"></p>
</div>
<p>For a batch of N cohorts, the database executes N independent
pipelines.</p>
<p>Each cohort creates its own local <code>#Codesets</code> temp table,
joins against <code>CONCEPT_ANCESTOR</code> and <code>CONCEPT</code> to
expand descendants, scans CDM domain tables
(e.g. <code>DRUG_EXPOSURE</code>, <code>CONDITION_OCCURRENCE</code>)
with joins to its local codesets, and writes directly to the results
tables. For N cohorts, the database performs:</p>
<ul>
<li>
<strong>N vocabulary expansions</strong> (CONCEPT_ANCESTOR
joins)</li>
<li>
<strong>N scans per CDM domain table</strong> used</li>
<li>
<strong>N DELETE + INSERT cycles</strong> on each result table</li>
</ul>
</div>
<div class="section level2">
<h2 id="the-optimized-batch-dag">The Optimized Batch DAG<a class="anchor" aria-label="anchor" href="#the-optimized-batch-dag"></a>
</h2>
<p>The optimizer restructures these N independent pipelines into a
single DAG with shared intermediate stages. The key insight is that
vocabulary expansion and CDM table scanning are
<strong>cohort-independent</strong> – we can do them once and share the
results.</p>
<div style="text-align: center;">
<p><img src="fig/cohort-json-141722.png" style="max-width: 100%; height: auto; transition: transform 0.25s cubic-bezier(.4,2,.6,1); cursor: zoom-in;" id="zoomable-img" onclick="
      var img = this;
      if (!img.classList.contains('zoomed')) {
        img.classList.add('zoomed');
        img.style.transform = 'scale(2)';
        img.style.zIndex = 1000;
        img.style.cursor = 'zoom-out';
      } else {
        img.classList.remove('zoomed');
        img.style.transform = '';
        img.style.zIndex = '';
        img.style.cursor = 'zoom-in';
      }
    "></p>
</div>
<p>The batch script executes in a strict topological order with no
back-edges or cross-cohort dependencies:</p>
<table class="table">
<colgroup>
<col width="24%">
<col width="44%">
<col width="31%">
</colgroup>
<thead><tr class="header">
<th>Phase</th>
<th>What happens</th>
<th>Shared?</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><strong>1. Staging setup</strong></td>
<td>Create <code>#COHORT_STAGE</code>,
<code>#INCLUSION_EVENTS_STAGE</code>,
<code>#INCLUSION_STATS_STAGE</code>
</td>
<td>Once</td>
</tr>
<tr class="even">
<td><strong>2. Global codesets</strong></td>
<td>Build <code>#CODESETS_GLOBAL</code> with all cohorts’ concept sets;
extract <code>#ALL_CONCEPTS</code>
</td>
<td>Once</td>
</tr>
<tr class="odd">
<td><strong>3. Domain filtering</strong></td>
<td>Create <code>##DRUG_EXPOSURE_FILTERED</code>,
<code>##CONDITION_OCCURRENCE_FILTERED</code>, etc.</td>
<td>Once per domain</td>
</tr>
<tr class="even">
<td><strong>4. Phase 1</strong></td>
<td>For each cohort: slice local <code>#Codesets</code> from global,
build primary events into <code>#QUALIFIED_EVENTS_ALL</code>
</td>
<td>Per-cohort, shared output</td>
</tr>
<tr class="odd">
<td><strong>5. Phase 2</strong></td>
<td>For each cohort: slice <code>#qualified_events</code> from
<code>#QUALIFIED_EVENTS_ALL</code>, run inclusion rules, end strategy,
write to staging</td>
<td>Per-cohort</td>
</tr>
<tr class="even">
<td><strong>6. Finalize</strong></td>
<td>Single DELETE by batch IDs + INSERT from staging into result
tables</td>
<td>Once</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="worked-example-three-drug-exposure-cohorts">Worked Example: Three Drug Exposure Cohorts<a class="anchor" aria-label="anchor" href="#worked-example-three-drug-exposure-cohorts"></a>
</h2>
<p>Consider three cohorts that identify users of different drugs:</p>
<ul>
<li>
<strong>Cohort A</strong>: Aspirin users (concept set with aspirin
concepts)</li>
<li>
<strong>Cohort B</strong>: Metformin users (concept set with
metformin concepts)</li>
<li>
<strong>Cohort C</strong>: Aspirin users with a diabetes diagnosis
(same primary criteria as A, plus an inclusion rule requiring a
condition occurrence)</li>
</ul>
<div class="section level3">
<h3 id="one-at-a-time-dag">One-at-a-Time DAG<a class="anchor" aria-label="anchor" href="#one-at-a-time-dag"></a>
</h3>
<p>Each cohort operates in complete isolation:</p>
<div style="text-align: center; width: 50%; margin-left: auto; margin-right: auto;">
<p><img src="fig/cohort-json-141722.png" style="max-width: 100%; height: auto;"></p>
</div>
<p>Notice: <code>CONCEPT_ANCESTOR</code> is joined 3 times;
<code>DRUG_EXPOSURE</code> is scanned 3 times;
<code>OBSERVATION_PERIOD</code> is scanned 3 times; aspirin concepts are
expanded twice (Cohorts A and C); 3 separate DELETE+INSERT cycles hit
the results table.</p>
</div>
<div class="section level3">
<h3 id="optimized-batch-dag">Optimized Batch DAG<a class="anchor" aria-label="anchor" href="#optimized-batch-dag"></a>
</h3>
<p>The optimizer merges the shared work:</p>
<div style="text-align: center;">
<p><img src="fig/cohort-json-142825.png" style="max-width: 100%; height: auto; transition: transform 0.25s cubic-bezier(.4,2,.6,1); cursor: zoom-in;" id="zoomable-optimized-dag-img" onclick="
      var img = this;
      if (!img.classList.contains('zoomed')) {
        img.classList.add('zoomed');
        img.style.transform = 'scale(2)';
        img.style.zIndex = 1000;
        img.style.cursor = 'zoom-out';
      } else {
        img.classList.remove('zoomed');
        img.style.transform = '';
        img.style.zIndex = '';
        img.style.cursor = 'zoom-in';
      }
    "></p>
</div>
<p>The savings are clear:</p>
<table class="table">
<thead><tr class="header">
<th>Operation</th>
<th>One-at-a-Time</th>
<th>Optimized</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>CONCEPT_ANCESTOR joins</td>
<td>3</td>
<td><strong>1</strong></td>
</tr>
<tr class="even">
<td>DRUG_EXPOSURE scans</td>
<td>3</td>
<td><strong>1</strong></td>
</tr>
<tr class="odd">
<td>OBSERVATION_PERIOD scans</td>
<td>3</td>
<td><strong>1</strong></td>
</tr>
<tr class="even">
<td>CONDITION_OCCURRENCE scans</td>
<td>1</td>
<td><strong>1</strong></td>
</tr>
<tr class="odd">
<td>Result table writes</td>
<td>3 DELETE + 3 INSERT</td>
<td><strong>1 DELETE + 1 INSERT</strong></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section level2">
<h2 id="how-equivalence-is-guaranteed">How Equivalence Is Guaranteed<a class="anchor" aria-label="anchor" href="#how-equivalence-is-guaranteed"></a>
</h2>
<p>The batch optimizer must produce <strong>exactly the same cohort
membership</strong> as running each cohort independently. We guarantee
this through four mechanisms:</p>
<div class="section level3">
<h3 id="same-builder-different-assembly">1. Same Builder, Different Assembly<a class="anchor" aria-label="anchor" href="#same-builder-different-assembly"></a>
</h3>
<p>Both paths use the <strong>same</strong>
<code>build_cohort_query_internal()</code> function to generate
per-cohort SQL. The batch path does not change the SQL logic; it only
changes how the pieces are assembled:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Single-cohort path:</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">build_cohort_query_internal</span><span class="op">(</span><span class="va">cohort</span>, <span class="va">opts</span><span class="op">)</span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="va">result</span><span class="op">$</span><span class="va">full_sql</span></span>
<span></span>
<span><span class="co"># Batch path (same builder, structured output):</span></span>
<span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">build_cohort_query_internal</span><span class="op">(</span><span class="va">cohort</span>, <span class="va">opts</span><span class="op">)</span></span>
<span><span class="co"># Uses result$codeset_union_parts, result$primary_events_sql,</span></span>
<span><span class="co"># result$tail_sql to assemble into batch script</span></span></code></pre></div>
<p>The structured output from the builder provides clean separation
points (<code>codeset_union_parts</code>,
<code>primary_events_sql</code>, <code>tail_sql</code>) rather than
relying on fragile regex extraction from generated SQL.</p>
</div>
<div class="section level3">
<h3 id="domain-filtering-includes-source-concepts">2. Domain Filtering Includes Source Concepts<a class="anchor" aria-label="anchor" href="#domain-filtering-includes-source-concepts"></a>
</h3>
<p>Domain-filtered tables include <strong>both</strong> standard and
source concept columns:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">SELECT</span> <span class="op">*</span> <span class="kw">INTO</span> ##DRUG_EXPOSURE_FILTERED</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">FROM</span> @cdm_database_schema.DRUG_EXPOSURE de</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="kw">WHERE</span> de.drug_concept_id <span class="kw">IN</span> (<span class="kw">SELECT</span> concept_id <span class="kw">FROM</span> #ALL_CONCEPTS)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>   <span class="kw">OR</span> de.drug_source_concept_id <span class="kw">IN</span> (<span class="kw">SELECT</span> concept_id <span class="kw">FROM</span> #ALL_CONCEPTS);</span></code></pre></div>
<p>This ensures rows that match only on
<code>drug_source_concept_id</code> (e.g., unmapped records with
<code>drug_concept_id = 0</code>) are not dropped in batch but retained,
matching the single-cohort behavior which queries the full CDM
table.</p>
</div>
<div class="section level3">
<h3 id="qualifiedlimit-preservation">3. QualifiedLimit Preservation<a class="anchor" aria-label="anchor" href="#qualifiedlimit-preservation"></a>
</h3>
<p>When a cohort specifies <code>QualifiedLimit: "First"</code>, the
single-cohort SQL includes <code>WHERE QE.ordinal = 1</code> to select
only the first qualifying event per person. The Phase 1 rewrite must
preserve this filter. The assembler explicitly checks:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In assemble_batch_script():</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">structured</span><span class="op">$</span><span class="va">has_qualified_limit</span><span class="op">)</span> <span class="op">&amp;&amp;</span></span>
<span>    <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"ordinal\\s*=\\s*1"</span>, <span class="va">ins2</span>, perl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">next</span>  <span class="co"># Skip Phase 1 for this cohort; run full script instead</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>If the rewritten INSERT does not contain the <code>ordinal = 1</code>
filter, the cohort is routed through the <strong>full script
path</strong> rather than the Phase 1 + tail path, preserving correct
semantics.</p>
</div>
<div class="section level3">
<h3 id="automated-equivalence-validation">4. Automated Equivalence Validation<a class="anchor" aria-label="anchor" href="#automated-equivalence-validation"></a>
</h3>
<p>The package includes <code><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/validate_batch_equivalence.html" class="external-link">validate_batch_equivalence()</a></code> which
runs both paths on the same CDM and compares results row-by-row:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co"># Run batch path</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>cdm <span class="ot">&lt;-</span> <span class="fu">generateCohortSet2</span>(cdm, cohortSet, <span class="at">name =</span> <span class="st">"batch_test"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co"># Run each cohort independently (optimize=FALSE)</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="cf">for</span> (each cohort) {</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>  <span class="fu">atlas_json_to_sql_batch</span>(single_cohort, <span class="at">optimize =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>}</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co"># Compare per cohort_definition_id:</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co"># (subject_id, cohort_start_date, cohort_end_date) must match exactly</span></span></code></pre></div>
<p>The test suite (<code>test-batch-equivalence.R</code>) verifies:</p>
<ul>
<li>Structured output completeness (full_sql, tail_sql,
primary_events_sql, codeset_union_parts)</li>
<li>Phase 1/Phase 2 generation for multi-cohort batches</li>
<li>QualifiedLimit preservation in Phase 1 inserts</li>
<li>Concept set exclusion handling (<code>isExcluded</code>,
<code>LEFT JOIN ... IS NULL</code>)</li>
<li>Mapped concept handling (<code>includeMapped</code>,
<code>concept_relationship</code> join)</li>
<li>Row-level equivalence on a synthetic CDM (when CDMConnector is
available)</li>
</ul>
</div>
<div class="section level3">
<h3 id="safety-mechanisms">Safety Mechanisms<a class="anchor" aria-label="anchor" href="#safety-mechanisms"></a>
</h3>
<p>Several additional safety checks prevent silent divergence:</p>
<ul>
<li>
<strong><code>can_vectorize</code> tracking</strong>: A boolean per
cohort that must be TRUE for the Phase 1 + tail path to be used</li>
<li>
<strong>EndStrategy detection</strong>: Cohorts with CustomEra or
DateOffset end strategies that reference <code>#strategy_ends</code>
skip Phase 1 and run the full script</li>
<li>
<strong>Unresolved parameter warnings</strong>:
<code>apply_batch_rewrites()</code> flags any <code>@</code>-parameters
that survive rewriting (except known-safe ones like
<code>@vocabulary_database_schema</code>)</li>
<li>
<strong><code>force_full_path</code> option</strong>: Setting
<code>options(atlasCohortGenerator.force_full_path = TRUE)</code>
disables Phase 1 entirely and routes all cohorts through the full script
path, useful for debugging</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="performance-characteristics">Performance Characteristics<a class="anchor" aria-label="anchor" href="#performance-characteristics"></a>
</h2>
<p>The speedup from batch optimization depends on the workload. The main
factors are: how many cohorts share vocabulary/domains, the size of the
CDM, and result-table I/O cost.</p>
<div class="section level3">
<h3 id="by-workload-type">By Workload Type<a class="anchor" aria-label="anchor" href="#by-workload-type"></a>
</h3>
<div class="section level4">
<h4 id="independent-cohorts-different-domains">Independent Cohorts (Different Domains)<a class="anchor" aria-label="anchor" href="#independent-cohorts-different-domains"></a>
</h4>
<p>Cohorts that use entirely different CDM domains (e.g., one uses only
<code>DRUG_EXPOSURE</code>, another only <code>MEASUREMENT</code>) still
benefit from:</p>
<ul>
<li>
<strong>Shared vocabulary expansion</strong>: 1 CONCEPT_ANCESTOR
join instead of N</li>
<li>
<strong>Shared result-table I/O</strong>: 1 finalize instead of
N</li>
<li>
<strong>No domain-scan savings</strong>: Each domain is only used by
one cohort, so filtering happens once either way</li>
</ul>
<p>Typical speedup: <strong>1.5–3x</strong> for 5–20 cohorts. The
savings come primarily from vocabulary and I/O consolidation.</p>
</div>
<div class="section level4">
<h4 id="independent-cohorts-overlapping-domains">Independent Cohorts (Overlapping Domains)<a class="anchor" aria-label="anchor" href="#independent-cohorts-overlapping-domains"></a>
</h4>
<p>Cohorts that share CDM domains (e.g., multiple drug-exposure cohorts,
or multiple condition-based cohorts) see the largest benefit:</p>
<ul>
<li>
<strong>Domain tables scanned once</strong>: A 500M-row
<code>DRUG_EXPOSURE</code> table is filtered once into
<code>##DRUG_EXPOSURE_FILTERED</code>, then all cohorts read from the
smaller filtered table</li>
<li>
<strong>Concept overlap</strong>: If cohorts share concepts (common
in phenotype libraries), the filtered tables are even smaller</li>
</ul>
<p>Typical speedup: <strong>3–10x</strong> for 10–50 cohorts sharing 2–3
domains. The savings grow roughly linearly with N because each
additional cohort avoids a full CDM scan.</p>
</div>
<div class="section level4">
<h4 id="subset-cohorts-same-primary-criteria-different-inclusion-rules">Subset Cohorts (Same Primary Criteria, Different Inclusion
Rules)<a class="anchor" aria-label="anchor" href="#subset-cohorts-same-primary-criteria-different-inclusion-rules"></a>
</h4>
<p>This is the best case. Subset cohorts (e.g., “all aspirin users”
vs. “aspirin users with diabetes” vs. “aspirin users over age 65”)
share:</p>
<ul>
<li>
<strong>Identical primary events</strong>: Phase 1 builds primary
events for each, but they read from the same
<code>##DRUG_EXPOSURE_FILTERED</code>
</li>
<li>
<strong>Same vocabulary</strong>: Often the exact same concept
sets</li>
<li>
<strong>Phase 2 is cheap</strong>: Only inclusion rules differ;
slicing from <code>#QUALIFIED_EVENTS_ALL</code> is fast</li>
</ul>
<p>Typical speedup: <strong>5–15x</strong> for 5–20 subset cohorts. The
primary-events build (the most expensive phase) operates on pre-filtered
data, and Phase 2 per-cohort blocks do minimal additional work.</p>
</div>
<div class="section level4">
<h4 id="large-phenotype-libraries-100-cohorts">Large Phenotype Libraries (100+ Cohorts)<a class="anchor" aria-label="anchor" href="#large-phenotype-libraries-100-cohorts"></a>
</h4>
<p>For large-scale studies generating 100+ cohorts:</p>
<ul>
<li>All vocabulary expansion is done once (can save minutes on large
vocabularies)</li>
<li>Domain tables are filtered once (can save tens of minutes for
billion-row CDMs)</li>
<li>Result-table I/O is a single bulk operation</li>
</ul>
<p>Typical speedup: <strong>5–20x</strong> depending on CDM size and
cohort diversity.</p>
</div>
</div>
<div class="section level3">
<h3 id="summary-table">Summary Table<a class="anchor" aria-label="anchor" href="#summary-table"></a>
</h3>
<table class="table">
<thead><tr class="header">
<th>Workload</th>
<th>N</th>
<th>Shared Domains</th>
<th>Speedup Range</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Independent, different domains</td>
<td>5–20</td>
<td>Low</td>
<td>1.5–3x</td>
</tr>
<tr class="even">
<td>Independent, overlapping domains</td>
<td>10–50</td>
<td>High</td>
<td>3–10x</td>
</tr>
<tr class="odd">
<td>Subset cohorts</td>
<td>5–20</td>
<td>Very high</td>
<td>5–15x</td>
</tr>
<tr class="even">
<td>Large phenotype library</td>
<td>100+</td>
<td>Mixed</td>
<td>5–20x</td>
</tr>
</tbody>
</table>
<p>The optimizer adds negligible overhead for small batches (&lt; 5
cohorts) and never produces slower results than the one-at-a-time
approach.</p>
</div>
</div>
<div class="section level2">
<h2 id="code-example">Code Example<a class="anchor" aria-label="anchor" href="#code-example"></a>
</h2>
<div class="section level3">
<h3 id="single-cohort-no-optimization">Single Cohort (No Optimization)<a class="anchor" aria-label="anchor" href="#single-cohort-no-optimization"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">atlasCohortGenerator</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate SQL for one cohort</span></span>
<span><span class="va">sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/atlas_json_to_sql.html" class="external-link">atlas_json_to_sql</a></span><span class="op">(</span></span>
<span>  json <span class="op">=</span> <span class="st">"path/to/aspirin_users.json"</span>,</span>
<span>  cohort_id <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  cdm_schema <span class="op">=</span> <span class="st">"cdm"</span>,</span>
<span>  target_schema <span class="op">=</span> <span class="st">"results"</span>,</span>
<span>  target_dialect <span class="op">=</span> <span class="st">"sql server"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="batch-optimized">Batch (Optimized)<a class="anchor" aria-label="anchor" href="#batch-optimized"></a>
</h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generate optimized batch SQL for multiple cohorts</span></span>
<span><span class="va">batch_sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/atlas_json_to_sql_batch.html" class="external-link">atlas_json_to_sql_batch</a></span><span class="op">(</span></span>
<span>  json_inputs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"path/to/aspirin_users.json"</span>,</span>
<span>    <span class="st">"path/to/metformin_users.json"</span>,</span>
<span>    <span class="st">"path/to/aspirin_diabetics.json"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  cdm_schema <span class="op">=</span> <span class="st">"@cdm_database_schema"</span>,</span>
<span>  results_schema <span class="op">=</span> <span class="st">"@results_schema"</span>,</span>
<span>  target_dialect <span class="op">=</span> <span class="st">"sql server"</span>,</span>
<span>  optimize <span class="op">=</span> <span class="cn">TRUE</span>  <span class="co"># default</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or with a cohort set data frame (e.g. from CDMConnector::readCohortSet)</span></span>
<span><span class="va">cohort_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  cohort_definition_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  cohort <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"aspirin.json"</span>, <span class="st">"metformin.json"</span>, <span class="st">"aspirin_diabetics.json"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_sql</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/atlas_json_to_sql_batch.html" class="external-link">atlas_json_to_sql_batch</a></span><span class="op">(</span></span>
<span>  json_inputs <span class="op">=</span> <span class="va">cohort_set</span>,</span>
<span>  optimize <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="with-cdmconnector">With CDMConnector<a class="anchor" aria-label="anchor" href="#with-cdmconnector"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://darwin-eu.github.io/CDMConnector/" class="external-link">CDMConnector</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">atlasCohortGenerator</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu">cdm_from_con</span><span class="op">(</span><span class="va">con</span>, cdm_schema <span class="op">=</span> <span class="st">"cdm"</span>, write_schema <span class="op">=</span> <span class="st">"results"</span><span class="op">)</span></span>
<span><span class="va">cohort_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readCohortSet.html">readCohortSet</a></span><span class="op">(</span><span class="st">"path/to/cohort/jsons/"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generateCohortSet2 uses the batch optimizer automatically</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohort_set</span>, name <span class="op">=</span> <span class="st">"my_cohorts"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="validating-equivalence">Validating Equivalence<a class="anchor" aria-label="anchor" href="#validating-equivalence"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Compare batch vs single-cohort results on your CDM</span></span>
<span><span class="va">ok</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/atlasCohortGenerator/man/validate_batch_equivalence.html" class="external-link">validate_batch_equivalence</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohort_set</span>, name <span class="op">=</span> <span class="st">"equiv_test"</span><span class="op">)</span></span>
<span><span class="co"># Prints per-cohort match status; returns TRUE if all match</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="debugging">Debugging<a class="anchor" aria-label="anchor" href="#debugging"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Dump the final batch SQL for inspection</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>atlasCohortGenerator.debug_sql_file <span class="op">=</span> <span class="st">"batch_debug.sql"</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohort_set</span>, name <span class="op">=</span> <span class="st">"debug_run"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Force all cohorts through the full (non-optimized) script path</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>atlasCohortGenerator.force_full_path <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">cdm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateCohortSet2.html">generateCohortSet2</a></span><span class="op">(</span><span class="va">cdm</span>, <span class="va">cohort_set</span>, name <span class="op">=</span> <span class="st">"full_path_run"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="appendix-how-the-dag-is-enforced">Appendix: How the DAG Is Enforced<a class="anchor" aria-label="anchor" href="#appendix-how-the-dag-is-enforced"></a>
</h2>
<p>The batch optimizer does not use an explicit graph data structure.
Instead, the DAG is <strong>enforced by SQL execution order</strong>:
the assembled script is a linear sequence of SQL statements where each
phase only references tables created in earlier phases. There are no
back-edges (later phases never write to tables read by earlier phases)
and no cross-cohort dependencies (no cohort’s Phase 2 block reads from
another cohort’s Phase 2 output).</p>
<p>This linear ordering is a valid topological sort of the implicit
DAG:</p>
<pre><code>#CODESETS_GLOBAL
    |
    v
#ALL_CONCEPTS
    |
    +----&gt; ##DRUG_EXPOSURE_FILTERED
    +----&gt; ##CONDITION_OCCURRENCE_FILTERED
    +----&gt; ##PROCEDURE_OCCURRENCE_FILTERED
    +----&gt; ... (other domains)
    +----&gt; ##ATLAS_OBSERVATION_PERIOD
           |
           v
    #QUALIFIED_EVENTS_ALL  (Phase 1: per-cohort inserts, shared table)
           |
           v
    Per-cohort Phase 2 blocks  (independent of each other)
           |
           v
    Staging tables (#COHORT_STAGE, ...)
           |
           v
    Finalize (results tables)</code></pre>
<p>Because Phase 2 blocks are independent, they could in principle be
parallelized. The current implementation executes them sequentially
within a single SQL batch, but the DAG structure means no ordering
constraint exists between different cohorts’ Phase 2 blocks.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Adam Black, Artem Gorbachev, Edward Burn, Marti Catala Sabate, Ioanna Nika.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
